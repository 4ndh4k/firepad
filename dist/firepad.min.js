!function(t,e,r){"undefined"!=typeof module&&module.exports?module.exports=e():"function"==typeof r.define&&r.define.amd?define(e):r.Firepad=e()}(0,function(){(O=O||{}).utils={},O.utils.makeEventEmitter=function(t,e){t.prototype.allowedEvents_=e,t.prototype.on=function(t,e,r){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[t]=this.eventListeners_[t]||[],this.eventListeners_[t].push({callback:e,context:r})},t.prototype.off=function(t,e){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{};for(var r=this.eventListeners_[t]||[],n=0;n<r.length;n++)if(r[n].callback===e)return void r.splice(n,1)},t.prototype.trigger=function(t){this.eventListeners_=this.eventListeners_||{};for(var e=this.eventListeners_[t]||[],r=0;r<e.length;r++)e[r].callback.apply(e[r].context,Array.prototype.slice.call(arguments,1))},t.prototype.validateEventType_=function(t){if(this.allowedEvents_){for(var e=!1,r=0;r<this.allowedEvents_.length;r++)if(this.allowedEvents_[r]===t){e=!0;break}if(!e)throw new Error('Unknown event "'+t+'"')}}},O.utils.elt=function(t,e,r){var n=document.createElement(t);if("string"==typeof e)O.utils.setTextContent(n,e);else if(e)for(var i=0;i<e.length;++i)n.appendChild(e[i]);for(var o in r||{})n.setAttribute(o,r[o]);return n},O.utils.setTextContent=function(t,e){t.innerHTML="",t.appendChild(document.createTextNode(e))},O.utils.on=function(t,e,r,n){t.addEventListener?t.addEventListener(e,r,n||!1):t.attachEvent&&t.attachEvent("on"+e,r)},O.utils.off=function(t,e,r,n){t.removeEventListener?t.removeEventListener(e,r,n||!1):t.detachEvent&&t.detachEvent("on"+e,r)},O.utils.preventDefault=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1},O.utils.stopPropagation=function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0},O.utils.stopEvent=function(t){O.utils.preventDefault(t),O.utils.stopPropagation(t)},O.utils.stopEventAnd=function(e){return function(t){return e(t),O.utils.stopEvent(t),!1}},O.utils.trim=function(t){return t.replace(/^\s+/g,"").replace(/\s+$/g,"")},O.utils.stringEndsWith=function(t,e){for(var r="string"==typeof e?[e]:e,n=0;n<r.length;n++){e=r[n];if(-1!==t.indexOf(e,t.length-e.length))return!0}return!1},O.utils.assert=function(t,e){if(!t)throw new Error(e||"assertion error")},O.utils.log=function(){if("undefined"!=typeof console&&void 0!==console.log){for(var t=["Firepad:"],e=0;e<arguments.length;e++)t.push(arguments[e]);console.log.apply(console,t)}},(O=O||{}).Span=function(){function t(t,e){this.pos=t,this.length=e}return t.prototype.end=function(){return this.pos+this.length},t}(),(O=O||{}).TextOp=function(){var e=O.utils;function t(t){this.type=t,this.chars=null,this.text=null,this.attributes=null,"insert"===t?(this.text=arguments[1],e.assert("string"==typeof this.text),this.attributes=arguments[2]||{},e.assert("object"==typeof this.attributes)):"delete"===t?(this.chars=arguments[1],e.assert("number"==typeof this.chars)):"retain"===t&&(this.chars=arguments[1],e.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},e.assert("object"==typeof this.attributes))}return t.prototype.isInsert=function(){return"insert"===this.type},t.prototype.isDelete=function(){return"delete"===this.type},t.prototype.isRetain=function(){return"retain"===this.type},t.prototype.equals=function(t){return this.type===t.type&&this.text===t.text&&this.chars===t.chars&&this.attributesEqual(t.attributes)},t.prototype.attributesEqual=function(t){for(var e in this.attributes)if(this.attributes[e]!==t[e])return!1;for(e in t)if(this.attributes[e]!==t[e])return!1;return!0},t.prototype.hasEmptyAttributes=function(){var t=!0;for(var e in this.attributes){t=!1;break}return t},t}(),(O=O||{}).TextOperation=function(){"use strict";var i=O.TextOp,m=O.utils;function p(){if(!this||this.constructor!==p)return new p;this.ops=[],this.baseLength=0,this.targetLength=0}function o(t){var e=t.ops;switch(e.length){case 1:return e[0];case 2:return e[0].isRetain()?e[1]:e[1].isRetain()?e[0]:null;case 3:if(e[0].isRetain()&&e[2].isRetain())return e[1]}return null}function s(t){return t.ops[0].isRetain()?t.ops[0].chars:0}return p.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(!this.ops[e].equals(t.ops[e]))return!1;return!0},p.prototype.retain=function(t,e){if("number"!=typeof t||t<0)throw new Error("retain expects a positive integer.");if(0===t)return this;this.baseLength+=t,this.targetLength+=t,e=e||{};var r=0<this.ops.length?this.ops[this.ops.length-1]:null;return r&&r.isRetain()&&r.attributesEqual(e)?r.chars+=t:this.ops.push(new i("retain",t,e)),this},p.prototype.insert=function(t,e){if("string"!=typeof t)throw new Error("insert expects a string");if(""===t)return this;e=e||{},this.targetLength+=t.length;var r=0<this.ops.length?this.ops[this.ops.length-1]:null,n=1<this.ops.length?this.ops[this.ops.length-2]:null;return r&&r.isInsert()&&r.attributesEqual(e)?r.text+=t:r&&r.isDelete()?n&&n.isInsert()&&n.attributesEqual(e)?n.text+=t:(this.ops[this.ops.length-1]=new i("insert",t,e),this.ops.push(r)):this.ops.push(new i("insert",t,e)),this},p.prototype.delete=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t||t<0)throw new Error("delete expects a positive integer or a string");if(0===t)return this;this.baseLength+=t;var e=0<this.ops.length?this.ops[this.ops.length-1]:null;return e&&e.isDelete()?e.chars+=t:this.ops.push(new i("delete",t)),this},p.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},p.prototype.clone=function(){for(var t=new p,e=0;e<this.ops.length;e++)this.ops[e].isRetain()?t.retain(this.ops[e].chars,this.ops[e].attributes):this.ops[e].isInsert()?t.insert(this.ops[e].text,this.ops[e].attributes):t.delete(this.ops[e].chars);return t},p.prototype.toString=function(){return(Array.prototype.map||function(t){for(var e=[],r=0,n=this.length;r<n;r++)e[r]=t(this[r]);return e}).call(this.ops,function(t){return t.isRetain()?"retain "+t.chars:t.isInsert()?"insert '"+t.text+"'":"delete "+t.chars}).join(", ")},p.prototype.toJSON=function(){for(var t=[],e=0;e<this.ops.length;e++)this.ops[e].hasEmptyAttributes()||t.push(this.ops[e].attributes),"retain"===this.ops[e].type?t.push(this.ops[e].chars):"insert"===this.ops[e].type?t.push(this.ops[e].text):"delete"===this.ops[e].type&&t.push(-this.ops[e].chars);return 0===t.length&&t.push(0),t},p.fromJSON=function(t){for(var e=new p,r=0,n=t.length;r<n;r++){var i=t[r],o={};"object"==typeof i&&(o=i,i=t[++r]),"number"==typeof i?0<i?e.retain(i,o):e.delete(-i):(m.assert("string"==typeof i),e.insert(i,o))}return e},p.prototype.apply=function(t,e,r){if(e=e||[],r=r||[],t.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var n,i,o=[],s=0,a=0,h=this.ops,c=0,u=h.length;c<u;c++){var l=h[c];if(l.isRetain()){if(a+l.chars>t.length)throw new Error("Operation can't retain more characters than are left in the string.");for(o[s++]=t.slice(a,a+l.chars),n=0;n<l.chars;n++){var p=e[a+n]||{},d={};for(i in p)d[i]=p[i],m.assert(!1!==d[i]);for(i in l.attributes)!1===l.attributes[i]?delete d[i]:d[i]=l.attributes[i],m.assert(!1!==d[i]);r.push(d)}a+=l.chars}else if(l.isInsert())for(o[s++]=l.text,n=0;n<l.text.length;n++){var f={};for(i in l.attributes)f[i]=l.attributes[i],m.assert(!1!==f[i]);r.push(f)}else a+=l.chars}if(a!==t.length)throw new Error("The operation didn't operate on the whole string.");var g=o.join("");return m.assert(g.length===r.length),g},p.prototype.invert=function(t){for(var e=0,r=new p,n=this.ops,i=0,o=n.length;i<o;i++){var s=n[i];s.isRetain()?(r.retain(s.chars),e+=s.chars):s.isInsert()?r.delete(s.text.length):(r.insert(t.slice(e,e+s.chars)),e+=s.chars)}return r},p.prototype.compose=function(t){if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");function e(t,e,r){var n,i={};for(n in t)i[n]=t[n];for(n in e)r&&!1===e[n]?delete i[n]:i[n]=e[n];return i}for(var r,n=new p,i=this.clone().ops,o=t.clone().ops,s=0,a=0,h=i[s++],c=o[a++];void 0!==h||void 0!==c;)if(h&&h.isDelete())n.delete(h.chars),h=i[s++];else if(c&&c.isInsert())n.insert(c.text,c.attributes),c=o[a++];else{if(void 0===h)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===c)throw new Error("Cannot compose operations: first operation is too long.");if(h.isRetain()&&c.isRetain())r=e(h.attributes,c.attributes),h.chars>c.chars?(n.retain(c.chars,r),h.chars-=c.chars,c=o[a++]):h.chars===c.chars?(n.retain(h.chars,r),h=i[s++],c=o[a++]):(n.retain(h.chars,r),c.chars-=h.chars,h=i[s++]);else if(h.isInsert()&&c.isDelete())h.text.length>c.chars?(h.text=h.text.slice(c.chars),c=o[a++]):h.text.length===c.chars?(h=i[s++],c=o[a++]):(c.chars-=h.text.length,h=i[s++]);else if(h.isInsert()&&c.isRetain())r=e(h.attributes,c.attributes,!0),h.text.length>c.chars?(n.insert(h.text.slice(0,c.chars),r),h.text=h.text.slice(c.chars),c=o[a++]):h.text.length===c.chars?(n.insert(h.text,r),h=i[s++],c=o[a++]):(n.insert(h.text,r),c.chars-=h.text.length,h=i[s++]);else{if(!h.isRetain()||!c.isDelete())throw new Error("This shouldn't happen: op1: "+JSON.stringify(h)+", op2: "+JSON.stringify(c));h.chars>c.chars?(n.delete(c.chars),h.chars-=c.chars,c=o[a++]):h.chars===c.chars?(n.delete(c.chars),h=i[s++],c=o[a++]):(n.delete(h.chars),c.chars-=h.chars,h=i[s++])}}return n},p.prototype.shouldBeComposedWith=function(t){if(this.isNoop()||t.isNoop())return!0;var e=s(this),r=s(t),n=o(this),i=o(t);return!(!n||!i)&&(n.isInsert()&&i.isInsert()?e+n.text.length===r:!(!n.isDelete()||!i.isDelete())&&(r+i.chars===e||e===r))},p.prototype.shouldBeComposedWithInverted=function(t){if(this.isNoop()||t.isNoop())return!0;var e=s(this),r=s(t),n=o(this),i=o(t);return!(!n||!i)&&(n.isInsert()&&i.isInsert()?e+n.text.length===r||e===r:!(!n.isDelete()||!i.isDelete())&&r+i.chars===e)},p.transformAttributes=function(t,e){var r,n={},i={},o={};for(r in t)o[r]=!0;for(r in e)o[r]=!0;for(r in o){var s=t[r],a=e[r];m.assert(null!=s||null!=a),null==s?i[r]=a:null==a?n[r]=s:s===a||(n[r]=s)}return[n,i]},p.transform=function(t,e){if(t.baseLength!==e.baseLength)throw new Error("Both operations have to have the same base length");for(var r=new p,n=new p,i=t.clone().ops,o=e.clone().ops,s=0,a=0,h=i[s++],c=o[a++];void 0!==h||void 0!==c;)if(h&&h.isInsert())r.insert(h.text,h.attributes),n.retain(h.text.length),h=i[s++];else if(c&&c.isInsert())r.retain(c.text.length),n.insert(c.text,c.attributes),c=o[a++];else{if(void 0===h)throw new Error("Cannot transform operations: first operation is too short.");if(void 0===c)throw new Error("Cannot transform operations: first operation is too long.");var u;if(h.isRetain()&&c.isRetain()){var l=p.transformAttributes(h.attributes,c.attributes);h.chars>c.chars?(u=c.chars,h.chars-=c.chars,c=o[a++]):h.chars===c.chars?(u=c.chars,h=i[s++],c=o[a++]):(u=h.chars,c.chars-=h.chars,h=i[s++]),r.retain(u,l[0]),n.retain(u,l[1])}else if(h.isDelete()&&c.isDelete())h.chars>c.chars?(h.chars-=c.chars,c=o[a++]):h.chars===c.chars?(h=i[s++],c=o[a++]):(c.chars-=h.chars,h=i[s++]);else if(h.isDelete()&&c.isRetain())h.chars>c.chars?(u=c.chars,h.chars-=c.chars,c=o[a++]):h.chars===c.chars?(u=c.chars,h=i[s++],c=o[a++]):(u=h.chars,c.chars-=h.chars,h=i[s++]),r.delete(u);else{if(!h.isRetain()||!c.isDelete())throw new Error("The two operations aren't compatible");h.chars>c.chars?(u=c.chars,h.chars-=c.chars,c=o[a++]):h.chars===c.chars?(u=h.chars,h=i[s++],c=o[a++]):(u=h.chars,c.chars-=h.chars,h=i[s++]),n.delete(u)}}return[r,n]},p.prototype.transform=function(t){return p.transform(this,t)},p}(),(O=O||{}).AnnotationList=function(){var h=O.Span;function u(t,e){if(!t)throw new Error("AnnotationList assertion failed"+(e?": "+e:""))}function p(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.attachedObject_=e.attachedObject}function d(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.node_=e}p.prototype.getAttachedObject=function(){return this.attachedObject_},d.prototype.attachObject=function(t){this.node_.attachedObject=t};var l={equals:function(){return!1}};function t(t){this.head_=new f(0,l),this.changeHandler_=t}function f(t,e){this.length=t,this.annotation=e,this.attachedObject=null,this.next=null}return t.prototype.insertAnnotatedSpan=function(i,o){this.wrapOperation_(new h(i.pos,0),function(t,e){u(!e||null===e.next);var r=new f(i.length,o);if(e){u(i.pos>t&&i.pos<t+e.length);var n=new f(0,l);return n.next=new f(i.pos-t,e.annotation),(n.next.next=r).next=new f(t+e.length-i.pos,e.annotation),n.next}return r})},t.prototype.removeSpan=function(o){0!==o.length&&this.wrapOperation_(o,function(t,e){u(null!==e);var r=new f(0,l),n=r;for(o.pos>t&&(n.next=new f(o.pos-t,e.annotation),n=n.next);o.end()>t+e.length;)t+=e.length,e=e.next;var i=t+e.length-o.end();return 0<i&&(n.next=new f(i,e.annotation)),r.next})},t.prototype.updateSpan=function(h,c){0!==h.length&&this.wrapOperation_(h,function(t,e){u(null!==e);var r=new f(0,l),n=r,i=t,o=h.pos-i;for(u(o<e.length),0<o&&(n.next=new f(o,e.annotation),i+=(n=n.next).length);null!==e&&h.end()>=t+e.length;){var s=t+e.length-i;n.next=new f(s,c(e.annotation,s)),n=n.next,t+=e.length,e=e.next,i=t}var a=h.end()-i;return 0<a&&(u(a<e.length),n.next=new f(a,c(e.annotation,a)),i+=(n=n.next).length,n.next=new f(t+e.length-i,e.annotation)),r.next})},t.prototype.wrapOperation_=function(t,e){if(t.pos<0)throw new Error("Span start cannot be negative.");var r,n=[],i=[],o=this.getAffectedNodes_(t);null!==o.start?(r=o.end.next,o.end.next=null):r=o.succ;var s=e(o.startPos,o.start),a=!1,h=!1;if(s){var c;for(this.mergeNodesWithSameAnnotations_(s),c=o.pred&&o.pred.annotation.equals(s.annotation)?(a=!0,s.length+=o.pred.length,o.beforePred.next=s,o.predPos):(o.beforeStart.next=s,o.startPos);s.next;)i.push(new d(c,s)),c+=s.length,s=s.next;o.succ&&o.succ.annotation.equals(s.annotation)?(s.length+=o.succ.length,h=!0,s.next=o.succ.next):s.next=r,i.push(new d(c,s))}else o.pred&&o.succ&&o.pred.annotation.equals(o.succ.annotation)?(h=a=!0,s=new f(o.pred.length+o.succ.length,o.pred.annotation),(o.beforePred.next=s).next=o.succ.next,i.push(new d(o.startPos-o.pred.length,s))):o.beforeStart.next=r;a&&n.push(new p(o.predPos,o.pred));for(var u=o.startPos,l=o.start;null!==l;)n.push(new p(u,l)),u+=l.length,l=l.next;h&&n.push(new p(u,o.succ)),this.changeHandler_(n,i)},t.prototype.getAffectedNodes_=function(t){for(var e={},r=null,n=this.head_,i=n.next,o=0;null!==i&&t.pos>=o+i.length;)o+=i.length,r=n,i=(n=i).next;if(null===i&&(0!==t.length||t.pos!==o))throw new Error("Span start exceeds the bounds of the AnnotationList.");for(e.startPos=o,0===t.length&&t.pos===o?e.start=null:e.start=i,e.beforeStart=n,o===t.pos&&0<o?(e.pred=n,e.predPos=o-n.length,e.beforePred=r):e.pred=null;null!==i&&t.end()>o;)o+=i.length,i=(n=i).next;if(t.end()>o)throw new Error("Span end exceeds the bounds of the AnnotationList.");return 0===t.length&&t.end()===o?e.end=null:e.end=n,e.succ=o===t.end()?i:null,e},t.prototype.mergeNodesWithSameAnnotations_=function(t){if(t)for(var e=null,r=t;r;)e&&e.annotation.equals(r.annotation)?(e.length+=r.length,e.next=r.next):e=r,r=r.next},t.prototype.forEach=function(t){for(var e=this.head_.next;null!==e;)t(e.length,e.annotation,e.attachedObject),e=e.next},t.prototype.getAnnotatedSpansForPos=function(t){for(var e=0,r=this.head_.next,n=null;null!==r&&e+r.length<=t;)e+=r.length,r=(n=r).next;if(null===r&&e!==t)throw new Error("pos exceeds the bounds of the AnnotationList");var i=[];return e===t&&n&&i.push(new p(e-n.length,n)),r&&i.push(new p(e,r)),i},t.prototype.getAnnotatedSpansForSpan=function(t){if(0===t.length)return[];for(var e=[],r=this.getAffectedNodes_(t),n=r.startPos,i=r.start;null!==i&&n<t.end();){var o=Math.max(n,t.pos),s=Math.min(n+i.length,t.end()),a=new h(o,s-o);a.annotation=i.annotation,e.push(a),n+=i.length,i=i.next}return e},t.prototype.count=function(){for(var t=0,e=this.head_.next,r=null;null!==e;)r&&u(!r.annotation.equals(e.annotation)),e=(r=e).next,t++;return t},f.prototype.clone=function(){var t=new f(this.spanLength,this.annotation);return t.next=this.next,t},t}(),(O=O||{}).Cursor=function(){"use strict";function r(t,e){this.position=t,this.selectionEnd=e}return r.fromJSON=function(t){return new r(t.position,t.selectionEnd)},r.prototype.equals=function(t){return this.position===t.position&&this.selectionEnd===t.selectionEnd},r.prototype.compose=function(t){return t},r.prototype.transform=function(o){function t(t){for(var e=t,r=o.ops,n=0,i=o.ops.length;n<i&&(r[n].isRetain()?t-=r[n].chars:r[n].isInsert()?e+=r[n].text.length:(e-=Math.min(t,r[n].chars),t-=r[n].chars),!(t<0));n++);return e}var e=t(this.position);return this.position===this.selectionEnd?new r(e,e):new r(e,t(this.selectionEnd))},r}(),(O=O||{}).FirebaseAdapter=function(t){"undefined"==typeof firebase&&"function"==typeof require&&"function"!=typeof Firebase&&(firebase=require("firebase"));var o=O.TextOperation,h=O.utils;function e(t,e,r){this.ref_=t,this.ready_=!1,this.firebaseCallbacks_=[],this.zombie_=!1,this.document_=new o,this.revision_=0,this.pendingReceivedRevisions_={};var n=this;if(e){this.setUserId(e),this.setColor(r);var i=t.root.child(".info/connected");this.firebaseOn_(i,"value",function(t){!0===t.val()&&n.initializeUserData_()},this),this.on("ready",function(){n.monitorCursors_()})}else this.userId_=t.push().key;setTimeout(function(){n.monitorHistory_()},0)}function c(t,e){if(!t)throw new Error(e||"assertion error")}h.makeEventEmitter(e,["ready","cursor","operation","ack","retry"]),e.prototype.dispose=function(){var t=this;this.ready_?(this.removeFirebaseCallbacks_(),this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("color").remove()),this.ref_=null,this.document_=null,this.zombie_=!0):this.on("ready",function(){t.dispose()})},e.prototype.setUserId=function(t){this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("cursor").onDisconnect().cancel(),this.userRef_.child("color").remove(),this.userRef_.child("color").onDisconnect().cancel()),this.userId_=t,this.userRef_=this.ref_.child("users").child(t),this.initializeUserData_()},e.prototype.isHistoryEmpty=function(){return c(this.ready_,"Not ready yet."),0===this.revision_},e.prototype.sendOperation=function(t,s){var a=this;if(this.ready_){c(this.document_.targetLength===t.baseLength,"sendOperation() called with invalid operation.");var e=i(this.revision_);this.sent_={id:e,op:t},function n(i,o){a.ref_.child("history").child(i).transaction(function(t){if(null===t)return o},function(t,e,r){if(t){if("disconnect"!==t.message)throw h.log("Transaction failure!",t),t;a.sent_&&a.sent_.id===i?setTimeout(function(){n(i,o)},0):s&&s(t,!1)}else s&&s(null,e)},!1)}(e,{a:a.userId_,o:t.toJSON(),t:firebase.database.ServerValue.TIMESTAMP})}else this.on("ready",function(){a.trigger("retry")})},e.prototype.sendCursor=function(t){this.userRef_.child("cursor").set(t),this.cursor_=t},e.prototype.setColor=function(t){this.userRef_.child("color").set(t),this.color_=t},e.prototype.getDocument=function(){return this.document_},e.prototype.registerCallbacks=function(t){for(var e in t)this.on(e,t[e])},e.prototype.initializeUserData_=function(){this.userRef_.child("cursor").onDisconnect().remove(),this.userRef_.child("color").onDisconnect().remove(),this.sendCursor(this.cursor_||null),this.setColor(this.color_||null)},e.prototype.monitorCursors_=function(){var t=this.ref_.child("users"),n=this;function e(t){var e=t.key,r=t.val();n.trigger("cursor",e,r.cursor,r.color)}this.firebaseOn_(t,"child_added",e),this.firebaseOn_(t,"child_changed",e),this.firebaseOn_(t,"child_removed",function(t){var e=t.key;n.trigger("cursor",e,null)})},e.prototype.monitorHistory_=function(){var i=this;this.ref_.child("checkpoint").once("value",function(t){if(!i.zombie_){var e=t.child("id").val(),r=t.child("o").val(),n=t.child("a").val();null!=r&&null!=e&&null!==n?(i.pendingReceivedRevisions_[e]={o:r,a:n},i.checkpointRevision_=function(t){c(0<t.length&&t[0]===s[t.length+8]);for(var e=0,r=1;r<t.length;r++)e*=s.length,e+=s.indexOf(t[r]);return e}(e),i.monitorHistoryStartingAt_(i.checkpointRevision_+1)):(i.checkpointRevision_=0,i.monitorHistoryStartingAt_(i.checkpointRevision_))}})},e.prototype.monitorHistoryStartingAt_=function(t){var e=this.ref_.child("history").startAt(null,i(t)),r=this;setTimeout(function(){r.firebaseOn_(e,"child_added",function(t){var e=t.key;r.pendingReceivedRevisions_[e]=t.val(),r.ready_&&r.handlePendingReceivedRevisions_()}),e.once("value",function(){r.handleInitialRevisions_()})},0)},e.prototype.handleInitialRevisions_=function(){c(!this.ready_,"Should not be called multiple times."),this.revision_=this.checkpointRevision_;for(var t=i(this.revision_),e=this.pendingReceivedRevisions_;null!=e[t];){var r=this.parseRevision_(e[t]);r?this.document_=this.document_.compose(r.operation):h.log("Invalid operation.",this.ref_.toString(),t,e[t]),delete e[t],this.revision_++,t=i(this.revision_)}this.trigger("operation",this.document_),this.ready_=!0;var n=this;setTimeout(function(){n.trigger("ready")},0)},e.prototype.handlePendingReceivedRevisions_=function(){for(var t=this.pendingReceivedRevisions_,e=i(this.revision_),r=!1;null!=t[e];){this.revision_++;var n=this.parseRevision_(t[e]);n?(this.document_=this.document_.compose(n.operation),this.sent_&&e===this.sent_.id?this.sent_.op.equals(n.operation)&&n.author===this.userId_?(this.revision_%100==0&&this.saveCheckpoint_(),this.sent_=null,this.trigger("ack")):(r=!0,this.trigger("operation",n.operation)):this.trigger("operation",n.operation)):h.log("Invalid operation.",this.ref_.toString(),e,t[e]),delete t[e],e=i(this.revision_)}r&&(this.sent_=null,this.trigger("retry"))},e.prototype.parseRevision_=function(t){if("object"!=typeof t)return null;if("string"!=typeof t.a||"object"!=typeof t.o)return null;var e=null;try{e=o.fromJSON(t.o)}catch(t){return null}return e.baseLength!==this.document_.targetLength?null:{author:t.a,operation:e}},e.prototype.saveCheckpoint_=function(){this.ref_.child("checkpoint").set({a:this.userId_,o:this.document_.toJSON(),id:i(this.revision_-1)})},e.prototype.firebaseOn_=function(t,e,r,n){return this.firebaseCallbacks_.push({ref:t,eventType:e,callback:r,context:n}),t.on(e,r,n),r},e.prototype.firebaseOff_=function(t,e,r,n){t.off(e,r,n);for(var i=0;i<this.firebaseCallbacks_.length;i++){var o=this.firebaseCallbacks_[i];if(o.ref===t&&o.eventType===e&&o.callback===r&&o.context===n){this.firebaseCallbacks_.splice(i,1);break}}},e.prototype.removeFirebaseCallbacks_=function(){for(var t=0;t<this.firebaseCallbacks_.length;t++){var e=this.firebaseCallbacks_[t];e.ref.off(e.eventType,e.callback,e.context)}this.firebaseCallbacks_=[]};var s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function i(t){if(0===t)return"A0";for(var e="";0<t;){var r=t%s.length;e=s[r]+e,t-=r,t/=s.length}return s[e.length+9]+e}return e}(),(O=O||{}).RichTextToolbar=function(t){var p=O.utils;function e(t){this.imageInsertionUI=t,this.element_=this.makeElement_()}return p.makeEventEmitter(e,["bold","italic","underline","strike","font","font-size","color","left","center","right","unordered-list","ordered-list","todo-list","indent-increase","indent-decrease","undo","redo","insert-image"]),e.prototype.element=function(){return this.element_},e.prototype.makeButton_=function(t,e){var r=this;e=e||t;var n=p.elt("a",[p.elt("span","",{class:"firepad-tb-"+e})],{class:"firepad-btn"});return p.on(n,"click",p.stopEventAnd(function(){r.trigger(t)})),n},e.prototype.makeElement_=function(){var t=this,e=this.makeFontDropdown_(),r=this.makeFontSizeDropdown_(),n=this.makeColorDropdown_(),i=[p.elt("div",[e],{class:"firepad-btn-group"}),p.elt("div",[r],{class:"firepad-btn-group"}),p.elt("div",[n],{class:"firepad-btn-group"}),p.elt("div",[t.makeButton_("bold"),t.makeButton_("italic"),t.makeButton_("underline"),t.makeButton_("strike","strikethrough")],{class:"firepad-btn-group"}),p.elt("div",[t.makeButton_("unordered-list","list-2"),t.makeButton_("ordered-list","numbered-list"),t.makeButton_("todo-list","list")],{class:"firepad-btn-group"}),p.elt("div",[t.makeButton_("indent-decrease"),t.makeButton_("indent-increase")],{class:"firepad-btn-group"}),p.elt("div",[t.makeButton_("left","paragraph-left"),t.makeButton_("center","paragraph-center"),t.makeButton_("right","paragraph-right")],{class:"firepad-btn-group"}),p.elt("div",[t.makeButton_("undo"),t.makeButton_("redo")],{class:"firepad-btn-group"})];t.imageInsertionUI&&i.push(p.elt("div",[t.makeButton_("insert-image")],{class:"firepad-btn-group"}));var o=p.elt("div",i,{class:"firepad-toolbar-wrapper"}),s=p.elt("div",null,{class:"firepad-toolbar"});return s.appendChild(o),s},e.prototype.makeFontDropdown_=function(){for(var t=["Arial","Comic Sans MS","Courier New","Impact","Times New Roman","Verdana"],e=[],r=0;r<t.length;r++){var n=p.elt("span",t[r]);n.setAttribute("style","font-family:"+t[r]),e.push({content:n,value:t[r]})}return this.makeDropdown_("Font","font",e)},e.prototype.makeFontSizeDropdown_=function(){for(var t=[9,10,12,14,18,24,32,42],e=[],r=0;r<t.length;r++){var n=p.elt("span",t[r].toString());n.setAttribute("style","font-size:"+t[r]+"px; line-height:"+(t[r]-6)+"px;"),e.push({content:n,value:t[r]})}return this.makeDropdown_("Size","font-size",e,"px")},e.prototype.makeColorDropdown_=function(){for(var t=["black","red","green","blue","yellow","cyan","magenta","grey"],e=[],r=0;r<t.length;r++){var n=p.elt("div");n.className="firepad-color-dropdown-item",n.setAttribute("style","background-color:"+t[r]),e.push({content:n,value:t[r]})}return this.makeDropdown_("Color","color",e)},e.prototype.makeDropdown_=function(t,n,e,i){i=i||"";var o=this,r=p.elt("a",t+" ▾",{class:"firepad-btn firepad-dropdown"}),s=p.elt("ul",[],{class:"firepad-dropdown-menu"});r.appendChild(s);var a=!1;var h=!1;function c(){a&&(s.style.display="",p.off(document,"click",c,!0),a=!1),h=!0,setTimeout(function(){h=!1},0)}function u(t,e){"object"!=typeof t&&(t=document.createTextNode(String(t)));var r=p.elt("a",[t]);p.on(r,"click",p.stopEventAnd(function(){c(),o.trigger(n,e+i)})),s.appendChild(r)}for(var l=0;l<e.length;l++){u(e[l].content,e[l].value)}return p.on(r,"click",p.stopEventAnd(function(){h||a||(s.style.display="block",p.on(document,"click",c,!0),a=!0)})),r},e}(),(O=O||{}).WrappedOperation=function(t){"use strict";function n(t,e){this.wrapped=t,this.meta=e}function i(t,e){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])}function o(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return n.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},n.prototype.invert=function(){var t=this.meta;return new n(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"==typeof t&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)},n.prototype.compose=function(t){return new n(this.wrapped.compose(t.wrapped),function(t,e){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(e);var r={};return i(t,r),i(e,r),r}return e}(this.meta,t.meta))},n.transform=function(t,e){var r=t.wrapped.transform(e.wrapped);return[new n(r[0],o(t.meta,e.wrapped)),new n(r[1],o(e.meta,t.wrapped))]},n.prototype.transform=function(t){return n.transform(this,t)},n}(),(O=O||{}).UndoManager=function(){"use strict";var e="normal",n="undoing",i="redoing";function t(t){this.maxItems=t||50,this.state=e,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function r(t,e){for(var r=[],n=e.constructor,i=t.length-1;0<=i;i--){var o=n.transform(t[i],e);"function"==typeof o[0].isNoop&&o[0].isNoop()||r.push(o[0]),e=o[1]}return r.reverse()}return t.prototype.add=function(t,e){if(this.state===n)this.redoStack.push(t),this.dontCompose=!0;else if(this.state===i)this.undoStack.push(t),this.dontCompose=!0;else{var r=this.undoStack;!this.dontCompose&&e&&0<r.length?r.push(t.compose(r.pop())):(r.push(t),r.length>this.maxItems&&r.shift()),this.dontCompose=!1,this.redoStack=[]}},t.prototype.transform=function(t){this.undoStack=r(this.undoStack,t),this.redoStack=r(this.redoStack,t)},t.prototype.performUndo=function(t){if(this.state=n,0===this.undoStack.length)throw new Error("undo not possible");t(this.undoStack.pop()),this.state=e},t.prototype.performRedo=function(t){if(this.state=i,0===this.redoStack.length)throw new Error("redo not possible");t(this.redoStack.pop()),this.state=e},t.prototype.canUndo=function(){return 0!==this.undoStack.length},t.prototype.canRedo=function(){return 0!==this.redoStack.length},t.prototype.isUndoing=function(){return this.state===n},t.prototype.isRedoing=function(){return this.state===i},t}(),(O=O||{}).Client=function(){"use strict";function t(){this.state=r}function e(){}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},t.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},t.prototype.sendOperation=function(t){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(t){throw new Error("applyOperation must be defined in child class")},(t.Synchronized=e).prototype.applyClient=function(t,e){return t.sendOperation(e),new n(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(t){throw new Error("There is no pending operation.")},e.prototype.serverRetry=function(t){throw new Error("There is no pending operation.")};var r=new e;function n(t){this.outstanding=t}function i(t,e){this.outstanding=t,this.buffer=e}return(t.AwaitingConfirm=n).prototype.applyClient=function(t,e){return new i(this.outstanding,e)},n.prototype.applyServer=function(t,e){var r=this.outstanding.transform(e);return t.applyOperation(r[1]),new n(r[0])},n.prototype.serverAck=function(t){return r},n.prototype.serverRetry=function(t){return t.sendOperation(this.outstanding),this},(t.AwaitingWithBuffer=i).prototype.applyClient=function(t,e){var r=this.buffer.compose(e);return new i(this.outstanding,r)},i.prototype.applyServer=function(t,e){var r=this.outstanding.transform(e),n=this.buffer.transform(r[1]);return t.applyOperation(n[1]),new i(r[0],n[0])},i.prototype.serverRetry=function(t){var e=this.outstanding.compose(this.buffer);return t.sendOperation(e),new n(e)},i.prototype.serverAck=function(t){return t.sendOperation(this.buffer),new n(this.buffer)},t}(),(O=O||{}).EditorClient=function(){"use strict";var o=O.Client,s=O.Cursor,r=O.UndoManager,a=O.WrappedOperation;function h(t,e){this.cursorBefore=t,this.cursorAfter=e}function n(t,e){this.id=t,this.editorAdapter=e}function t(t,e){o.call(this),this.serverAdapter=t,this.editorAdapter=e,this.undoManager=new r,this.clients={};var i=this;this.editorAdapter.registerCallbacks({change:function(t,e){i.onChange(t,e)},cursorActivity:function(){i.onCursorActivity()},blur:function(){i.onBlur()},focus:function(){i.onFocus()}}),this.editorAdapter.registerUndo(function(){i.undo()}),this.editorAdapter.registerRedo(function(){i.redo()}),this.serverAdapter.registerCallbacks({ack:function(){i.serverAck(),i.focused&&i.state instanceof o.Synchronized&&(i.updateCursor(),i.sendCursor(i.cursor)),i.emitStatus()},retry:function(){i.serverRetry()},operation:function(t){i.applyServer(t)},cursor:function(t,e,r){if(i.serverAdapter.userId_!==t&&i.state instanceof o.Synchronized){var n=i.getClientObject(t);e?(r&&n.setColor(r),n.updateCursor(s.fromJSON(e))):n.removeCursor()}}})}return h.prototype.invert=function(){return new h(this.cursorAfter,this.cursorBefore)},h.prototype.compose=function(t){return new h(this.cursorBefore,t.cursorAfter)},h.prototype.transform=function(t){return new h(this.cursorBefore?this.cursorBefore.transform(t):null,this.cursorAfter?this.cursorAfter.transform(t):null)},n.prototype.setColor=function(t){this.color=t},n.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.mark=this.editorAdapter.setOtherCursor(t,this.color,this.id)},n.prototype.removeCursor=function(){this.mark&&this.mark.clear()},function(t,e){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t}(t,o),t.prototype.getClientObject=function(t){var e=this.clients[t];return e||(this.clients[t]=new n(t,this.editorAdapter))},t.prototype.applyUnredo=function(t){this.undoManager.add(this.editorAdapter.invertOperation(t)),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.cursor&&this.editorAdapter.setCursor(this.cursor),this.applyClient(t.wrapped)},t.prototype.undo=function(){var e=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(t){e.applyUnredo(t)})},t.prototype.redo=function(){var e=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(t){e.applyUnredo(t)})},t.prototype.onChange=function(t,e){var r=this.cursor;this.updateCursor();var n,i=0<this.undoManager.undoStack.length&&e.shouldBeComposedWithInverted((n=this.undoManager.undoStack,n[n.length-1]).wrapped),o=new h(this.cursor,r);this.undoManager.add(new a(e,o),i),this.applyClient(t)},t.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},t.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),!this.focused||t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},t.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null),this.focused=!1},t.prototype.onFocus=function(){this.focused=!0,this.onCursorActivity()},t.prototype.sendCursor=function(t){this.state instanceof o.AwaitingWithBuffer||this.serverAdapter.sendCursor(t)},t.prototype.sendOperation=function(t){this.serverAdapter.sendOperation(t),this.emitStatus()},t.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new a(t,null))},t.prototype.emitStatus=function(){var t=this;setTimeout(function(){t.trigger("synced",t.state instanceof o.Synchronized)},0)},t}(),O.utils.makeEventEmitter(O.EditorClient,["synced"]);var O,e=function(){function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}();return null==O&&(O={}),O.ACEAdapter=function(){var t=function(){function r(t){var e;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,r),this.onChange=this.onChange.bind(this),this.onBlur=this.onBlur.bind(this),this.onFocus=this.onFocus.bind(this),this.onCursorActivity=this.onCursorActivity.bind(this),this.ace=t,this.aceSession=this.ace.getSession(),this.aceDoc=this.aceSession.getDocument(),this.aceDoc.setNewLineMode("unix"),this.grabDocumentState(),this.ace.on("change",this.onChange),this.ace.on("blur",this.onBlur),this.ace.on("focus",this.onFocus),this.aceSession.selection.on("changeCursor",this.onCursorActivity),null==this.aceRange&&(this.aceRange=(null!=(e=ace.require)?e:require)("ace/range").Range)}return e(r,[{key:"grabDocumentState",value:function(){return this.lastDocLines=this.aceDoc.getAllLines(),this.lastCursorRange=this.aceSession.selection.getRange()}},{key:"detach",value:function(){return this.ace.removeListener("change",this.onChange),this.ace.removeListener("blur",this.onBlur),this.ace.removeListener("focus",this.onFocus),this.aceSession.selection.removeListener("changeCursor",this.onCursorActivity)}},{key:"onChange",value:function(t){var e;if(!this.ignoreChanges)return e=this.operationFromACEChange(t),this.trigger.apply(this,["change"].concat(function(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}(e))),this.grabDocumentState()}},{key:"onBlur",value:function(){if(this.ace.selection.isEmpty())return this.trigger("blur")}},{key:"onFocus",value:function(){return this.trigger("focus")}},{key:"onCursorActivity",value:function(){var t=this;return setTimeout(function(){return t.trigger("cursorActivity")},0)}},{key:"operationFromACEChange",value:function(t){var e,r,n,i,o,s,a;return s=t.data?("insertLines"===(i=(r=t.data).action)||"removeLines"===i?(a=r.lines.join("\n")+"\n",r.action.replace("Lines","")):(a=r.text.replace(this.aceDoc.getNewLineCharacter(),"\n"),r.action.replace("Text","")),this.indexFromPos(r.range.start)):(a=t.lines.join("\n"),this.indexFromPos(t.start)),o=this.lastDocLines.join("\n").length-s,"remove"===t.action&&(o-=a.length),n=(new O.TextOperation).retain(s).insert(a).retain(o),e=(new O.TextOperation).retain(s).delete(a).retain(o),"remove"===t.action?[e,n]:[n,e]}},{key:"applyOperationToACE",value:function(t){var e,r,n,i,o,s,a,h;for(n=r=0,i=(a=t.ops).length;n<i;n++)(o=a[n]).isRetain()?r+=o.chars:o.isInsert()?(this.aceDoc.insert(this.posFromIndex(r),o.text),r+=o.text.length):o.isDelete()&&(e=this.posFromIndex(r),h=this.posFromIndex(r+o.chars),s=this.aceRange.fromPoints(e,h),this.aceDoc.remove(s));return this.grabDocumentState()}},{key:"posFromIndex",value:function(t){var e,r,n,i,o;for(o=e=0,r=(i=this.aceDoc.$lines).length;e<r&&!(t<=(n=i[o]).length);o=++e)t-=n.length+1;return{row:o,column:t}}},{key:"indexFromPos",value:function(t,e){var r,n,i,o;for(null==e&&(e=this.lastDocLines),r=i=n=0,o=t.row;0<=o?i<o:o<i;r=0<=o?++i:--i)n+=this.lastDocLines[r].length+1;return n+t.column}},{key:"getValue",value:function(){return this.aceDoc.getValue()}},{key:"getCursor",value:function(){var e,r,n;try{n=this.indexFromPos(this.aceSession.selection.getRange().start,this.aceDoc.$lines),r=this.indexFromPos(this.aceSession.selection.getRange().end,this.aceDoc.$lines)}catch(t){t;try{n=this.indexFromPos(this.lastCursorRange.start),r=this.indexFromPos(this.lastCursorRange.end)}catch(t){e=t,console.log("Couldn't figure out the cursor range:",e,"-- setting it to 0:0."),r=n=0}}if(r<n){var t=[r,n];n=t[0],r=t[1]}return new O.Cursor(n,r)}},{key:"setCursor",value:function(t){var e,r;if(r=this.posFromIndex(t.position),e=this.posFromIndex(t.selectionEnd),t.position>t.selectionEnd){var n=[e,r];r=n[0],e=n[1]}return this.aceSession.selection.setSelectionRange(new this.aceRange(r.row,r.column,e.row,e.column))}},{key:"setOtherCursor",value:function(t,e,r){var n,i,o,s,a,h,c,u=this;if(null==this.otherCursors&&(this.otherCursors={}),(o=this.otherCursors[r])&&(o.start.detach(),o.end.detach(),this.aceSession.removeMarker(o.id)),c=this.posFromIndex(t.position),s=this.posFromIndex(t.selectionEnd),t.selectionEnd<t.position){var l=[s,c];c=l[0],s=l[1]}return n="other-client-selection-"+e.replace("#",""),(a=t.position===t.selectionEnd)&&(n=n.replace("selection","cursor")),i="."+n+" {\n  position: absolute;\n  background-color: "+(a?"transparent":e)+";\n  border-left: 2px solid "+e+";\n}",this.addStyleRule(i),this.otherCursors[r]=o=new this.aceRange(c.row,c.column,s.row,s.column),h=this,o.clipRows=function(){var t;return(t=h.aceRange.prototype.clipRows.apply(this,arguments)).isEmpty=function(){return!1},t},o.start=this.aceDoc.createAnchor(o.start),o.end=this.aceDoc.createAnchor(o.end),o.id=this.aceSession.addMarker(o,n,"text"),{clear:function(){return o.start.detach(),o.end.detach(),u.aceSession.removeMarker(o.id)}}}},{key:"addStyleRule",value:function(t){var e;if("undefined"!=typeof document&&null!==document&&(this.addedStyleRules||(this.addedStyleRules={},e=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(e),this.addedStyleSheet=e.sheet),!this.addedStyleRules[t]))return this.addedStyleRules[t]=!0,this.addedStyleSheet.insertRule(t,0)}},{key:"registerCallbacks",value:function(t){this.callbacks=t}},{key:"trigger",value:function(t){for(var e,r,n=arguments.length,i=Array(1<n?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return null!=(e=this.callbacks)&&null!=(r=e[t])?r.apply(this,i):void 0}},{key:"applyOperation",value:function(t){return t.isNoop()||(this.ignoreChanges=!0),this.applyOperationToACE(t),this.ignoreChanges=!1}},{key:"registerUndo",value:function(t){return this.ace.undo=t}},{key:"registerRedo",value:function(t){return this.ace.redo=t}},{key:"invertOperation",value:function(t){return t.invert(this.getValue())}}]),r}();return t.prototype.ignoreChanges=!1,t}.call(void 0),O.MonacoAdapter=function(){var o=function(t,e){return function(){return t.apply(e,arguments)}},r=[].slice;function t(t){this.onCursorActivity=o(this.onCursorActivity,this),this.onFocus=o(this.onFocus,this),this.onBlur=o(this.onBlur,this),this.onChange=o(this.onChange,this),this.monaco=t,this.monacoModel=this.monaco.getModel(),this.grabDocumentState();var e=this.monaco.onDidChangeModelContent(this.onChange),r=this.monaco.onDidBlurEditorWidget(this.onBlur),n=this.monaco.onDidFocusEditorWidget(this.onFocus),i=this.monaco.onDidChangeCursorPosition(this.onCursorActivity);this.detach=function(){e.dispose(),r.dispose(),n.dispose(),i.dispose()}}return t.prototype.ignoreChanges=!1,t.prototype.grabDocumentState=function(){this.lastDocLines=this.monacoModel.getLinesContent();var t=this.monaco.getSelection();return this.lastCursorRange=t},t.prototype.onChange=function(t){var e;if(!this.ignoreChanges)return e=this.operationFromMonacoChange(t),this.trigger.apply(this,["change"].concat(r.call(e))),this.grabDocumentState()},t.prototype.onBlur=function(){if(this.monaco.getSelection().isEmpty())return this.trigger("blur")},t.prototype.onFocus=function(){return this.trigger("focus")},t.prototype.onCursorActivity=function(){var t=this;return setTimeout(function(){return t.trigger("cursorActivity")},0)},t.prototype.operationFromMonacoChange=function(t){return text=t.changes[0].text,start=this.indexFromPos(t.changes[0].range,"start"),restLength=this.lastDocLines.join(this.monacoModel.getEOL()).length-start,text_ins=t.changes[0].text,rangeLen=t.changes[0].rangeLength,0<t.changes[0].rangeLength&&(restLength-=rangeLen,text=this.lastDocLines.join(this.monacoModel.getEOL()).slice(start,start+rangeLen)),insert_op=(new O.TextOperation).retain(start).insert(text).retain(restLength),delete_op=(new O.TextOperation).retain(start).delete(text).retain(restLength),ins_op_ne=(new O.TextOperation).retain(start).delete(text_ins).insert(text).retain(restLength),del_op_ne=(new O.TextOperation).retain(start).delete(text).insert(text_ins).retain(restLength),""===t.changes[0].text&&0<rangeLen?[delete_op,insert_op]:""!==t.changes[0].text&&0<rangeLen?[del_op_ne,ins_op_ne]:[insert_op,delete_op]},t.prototype.applyOperationToMonaco=function(t){var e,r,n,i,o,s,a,h;for(o=r=0,s=(a=t.ops).length;o<s;o++)(n=a[o]).isRetain()?r+=n.chars:n.isInsert()?(h={identifier:{major:1,minor:1},range:new monaco.Range(this.posFromIndex(r).row,this.posFromIndex(r).column,this.posFromIndex(r).row,this.posFromIndex(r).column),text:n.text,forceMoveMarkers:!0},this.monaco.executeEdits("my-source",[h]),r+=n.text.length):n.isDelete()&&(content=this.monacoModel.getLinesContent(),e=this.posFromIndex(r,content),i=this.posFromIndex(r+n.chars,content),h={identifier:{major:1,minor:2},range:new monaco.Range(e.row,e.column,i.row,i.column),text:"",forceMoveMarkers:!0},this.monaco.executeEdits("my-source",[h]));return this.grabDocumentState()},t.prototype.posFromIndex=function(t,e){var r,n,i,o,s;for(n=i=0,o=(s=null==e?this.lastDocLines:e).length;i<o&&!(t<=(r=s[n]).length);n=++i)t-=r.length+this.monacoModel.getEOL().length;return{row:n+1,column:t+1}},t.prototype.indexFromPos=function(t,e,r){var n;if(null==r&&(r=this.lastDocLines),n=0,"start"===e){for(row=1;row<t.startLineNumber;row++)n+=r[row-1].length+this.monacoModel.getEOL().length;return n+t.startColumn-1}for(row=1;row<t.endLineNumber;row++)n+=r[row-1].length+this.monacoModel.getEOL().length;return n+t.endColumn-1},t.prototype.getValue=function(){return this.monacoModel.getValue()},t.prototype.getCursor=function(){var e,r,n,i,t;try{selection=this.monaco.getSelection(),n=this.indexFromPos(selection,"start",this.lastDocLines),r=this.indexFromPos(selection,"end",this.lastDocLines)}catch(t){t;try{n=this.indexFromPos(this.lastCursorRange,"start"),r=this.indexFromPos(this.lastCursorRange,"end")}catch(t){e=t,console.log("Couldn't figure out the cursor range:",e,"-- setting it to 0:0."),n=(i=[0,0])[0],r=i[1]}}return r<n&&(n=(t=[r,n])[0],r=t[1]),new O.Cursor(n,r)},t.prototype.setCursor=function(t){var e,r,n;return r=this.posFromIndex(t.position),e=this.posFromIndex(t.selectionEnd),t.position>t.selectionEnd&&(r=(n=[e,r])[0],e=n[1]),this.monaco.setSelection(new monaco.Range(r.row,r.column,e.row,e.column))},t.prototype.setOtherCursor=function(t,e,r){if(null==this.otherCursors&&(this.otherCursors={},this.otherCursors[r]=[]),this.otherCursors[r]&&(this.otherCursors[r]=this.monaco.deltaDecorations(this.otherCursors[r],[])),start=this.posFromIndex(t.position),end=this.posFromIndex(t.selectionEnd),clazz="other-client-selection-"+e.replace("#",""),!(start<0||end<0||start>end))return justCursor=t.position===t.selectionEnd,justCursor&&(clazz=clazz.replace("selection","cursor")),css="."+clazz+" {\n  position: relative;\nbackground-color: "+(justCursor?"transparent":e)+";\nborder-left: 2px solid "+e+";\n}",this.addStyleRule(css),this.otherCursors[r]=this.monaco.deltaDecorations(this.otherCursors[r],[{range:new monaco.Range(start.row,start.column,end.row,end.column),options:{className:clazz}}]),_this=this,{clear:function(){return _this.monaco.deltaDecorations(_this.otherCursors[r],[])}}},t.prototype.addStyleRule=function(t){var e;if("undefined"!=typeof document&&null!==document&&(this.addedStyleRules||(this.addedStyleRules={},e=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(e),this.addedStyleSheet=e.sheet),!this.addedStyleRules[t]))return this.addedStyleRules[t]=!0,this.addedStyleSheet.insertRule(t,0)},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},t.prototype.applyOperation=function(t){return t.isNoop()||(this.ignoreChanges=!0),this.applyOperationToMonaco(t),this.ignoreChanges=!1},t.prototype.registerUndo=function(t){return this.monacoModel.undo=t},t.prototype.registerRedo=function(t){return this.monacoModel.redo=t},t.prototype.invertOperation=function(t){return t.invert(this.getValue())},t}(),(O=O||{}).AttributeConstants={BOLD:"b",ITALIC:"i",UNDERLINE:"u",STRIKE:"s",FONT:"f",FONT_SIZE:"fs",COLOR:"c",BACKGROUND_COLOR:"bc",ENTITY_SENTINEL:"ent",LINE_SENTINEL:"l",LINE_INDENT:"li",LINE_ALIGN:"la",LIST_TYPE:"lt"},O.sentinelConstants={LINE_SENTINEL_CHARACTER:"",ENTITY_SENTINEL_CHARACTER:""},(O=O||{}).EntityManager=function(){var o=O.utils;function t(){this.entities_={};var i=["src","alt","width","height","style","class"];this.register("img",{render:function(t){o.assert(t.src,"image entity should have 'src'!");for(var e=["src","alt","width","height","style","class"],r="<img ",n=0;n<e.length;n++){var i=e[n];i in t&&(r+=" "+i+'="'+t[i]+'"')}return r+=">"},fromElement:function(t){for(var e={},r=0;r<i.length;r++){var n=i[r];t.hasAttribute(n)&&(e[n]=t.getAttribute(n))}return e}})}return t.prototype.register=function(t,e){O.utils.assert(e.render,"Entity options should include a 'render' function!"),O.utils.assert(e.fromElement,"Entity options should include a 'fromElement' function!"),this.entities_[t]=e},t.prototype.renderToElement=function(t,e){return this.tryRenderToElement_(t,"render",e)},t.prototype.exportToElement=function(t){var e=this.tryRenderToElement_(t,"export")||this.tryRenderToElement_(t,"getHtml")||this.tryRenderToElement_(t,"render");return e.setAttribute("data-firepad-entity",t.type),e},t.prototype.updateElement=function(t,e){var r=t.type,n=t.info;this.entities_[r]&&void 0!==this.entities_[r].update&&this.entities_[r].update(n,e)},t.prototype.fromElement=function(t){var e=t.getAttribute("data-firepad-entity");if(e||(e=t.nodeName.toLowerCase()),e&&this.entities_[e]){var r=this.entities_[e].fromElement(t);return new O.Entity(e,r)}},t.prototype.tryRenderToElement_=function(t,e,r){var n=t.type,i=t.info;if(this.entities_[n]&&this.entities_[n][e]){var o=O.document||window&&window.document,s=this.entities_[n][e](i,r,o);if(s){if("string"==typeof s){var a=(O.document||document).createElement("div");return a.innerHTML=s,a.childNodes[0]}if("object"==typeof s)return O.utils.assert(void 0!==s.nodeType,"Error rendering "+n+" entity.  render() function must return an html string or a DOM element."),s}}},t.prototype.entitySupportsUpdate=function(t){return this.entities_[t]&&this.entities_[t].update},t}(),(O=O||{}).Entity=function(){var i=O.AttributeConstants.ENTITY_SENTINEL,o=i+"_";function s(t,e){if(!(this instanceof s))return new s(t,e);this.type=t,this.info=e||{}}return s.prototype.toAttributes=function(){var t={};for(var e in t[i]=this.type,this.info)t[o+e]=this.info[e];return t},s.fromAttributes=function(t){var e=t[i],r={};for(var n in t)0===n.indexOf(o)&&(r[n.substr(o.length)]=t[n]);return new s(e,r)},s}(),(O=O||{}).RichTextCodeMirror=function(){var i=O.AnnotationList,m=O.Span,o=O.utils,d=O.AttributeConstants,c={c:"color",bc:"background-color",fs:"font-size",li:function(t){return"padding-left: "+40*t+"px"}},u={};function t(t,e,r){this.codeMirror=t,this.options_=r||{},this.entityManager_=e,this.currentAttributes_=null;var n=this;this.annotationList_=new i(function(t,e){n.onAnnotationsChanged_(t,e)}),this.initAnnotationList_(),a(this,"onCodeMirrorBeforeChange_"),a(this,"onCodeMirrorChange_"),a(this,"onCursorActivity_"),4<=parseInt(CodeMirror.version)?this.codeMirror.on("changes",this.onCodeMirrorChange_):this.codeMirror.on("change",this.onCodeMirrorChange_),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.on("cursorActivity",this.onCursorActivity_),this.changeId_=0,this.outstandingChanges_={},this.dirtyLines_=[]}o.makeEventEmitter(t,["change","attributesChange","newLine"]);var p=O.sentinelConstants.LINE_SENTINEL_CHARACTER,s=O.sentinelConstants.ENTITY_SENTINEL_CHARACTER;function r(t,e){return t.line-e.line||t.ch-e.ch}function l(t,e){return r(t,e)<=0}function f(t){if(0===t.length)return 0;for(var e=0,r=0;r<t.length;r++)e+=t[r].length;return e+t.length-1}function y(t){this.attributes=t||{}}function a(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}return t.prototype.detach=function(){this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.off("change",this.onCodeMirrorChange_),this.codeMirror.off("changes",this.onCodeMirrorChange_),this.codeMirror.off("cursorActivity",this.onCursorActivity_),this.clearAnnotations_()},t.prototype.toggleAttribute=function(t,e){var r=e||!0;if(this.emptySelection_()){var n=this.getCurrentAttributes_();n[t]===r?delete n[t]:n[t]=r,this.currentAttributes_=n}else{var i=this.getCurrentAttributes_()[t]!==r&&r;this.setAttribute(t,i)}},t.prototype.setAttribute=function(e,r){var t=this.codeMirror;if(this.emptySelection_()){var n=this.getCurrentAttributes_();!1===r?delete n[e]:n[e]=r,this.currentAttributes_=n}else this.updateTextAttributes(t.indexFromPos(t.getCursor("start")),t.indexFromPos(t.getCursor("end")),function(t){!1===r?delete t[e]:t[e]=r}),this.updateCurrentAttributes_()},t.prototype.updateTextAttributes=function(t,e,s,a,h){var c=[],u=t,l=this;this.annotationList_.updateSpan(new m(t,e-t),function(t,e){var r={};for(var n in t.attributes)r[n]=t.attributes[n];r[d.LINE_SENTINEL]&&!h||s(r);var i={},o={};return l.computeChangedAttributes_(t.attributes,r,i,o),function(t){for(var e in t)return!1;return!0}(i)||c.push({start:u,end:u+e,attributes:i,attributesInverse:o,origin:a}),u+=e,new y(r)}),0<c.length&&this.trigger("attributesChange",this,c)},t.prototype.computeChangedAttributes_=function(t,e,r,n){var i,o={};for(i in t)o[i]=!0;for(i in e)o[i]=!0;for(i in o)i in e?i in t?t[i]!==e[i]&&(r[i]=e[i],n[i]=t[i]):(r[i]=e[i],n[i]=!1):(r[i]=!1,n[i]=t[i])},t.prototype.toggleLineAttribute=function(t,e){var r,n=this.getCurrentLineAttributes_();r=!(t in n&&n[t]===e)&&e,this.setLineAttribute(t,r)},t.prototype.setLineAttribute=function(e,r){this.updateLineAttributesForSelection(function(t){!1===r?delete t[e]:t[e]=r})},t.prototype.updateLineAttributesForSelection=function(t){var e=this.codeMirror,r=e.getCursor("start"),n=e.getCursor("end"),i=r.line,o=n.line,s=e.getLine(o),a=this.areLineSentinelCharacters_(s.substr(0,n.ch));i<o&&a&&o--,this.updateLineAttributes(i,o,t)},t.prototype.updateLineAttributes=function(t,e,r){for(var n=t;n<=e;n++){var i=this.codeMirror.getLine(n),o=this.codeMirror.indexFromPos({line:n,ch:0});if(i[0]!==p){var s={};s[d.LINE_SENTINEL]=!0,r(s),this.insertText(o,p,s)}else this.updateTextAttributes(o,o+1,r,null,!0)}},t.prototype.replaceText=function(t,e,r,n,i){this.changeId_++;var o="cmrt-"+this.changeId_;this.outstandingChanges_[o]={origOrigin:i,attributes:n};var s=this.codeMirror,a=s.posFromIndex(t),h="number"==typeof e?s.posFromIndex(e):null;s.replaceRange(r,a,h,o)},t.prototype.insertText=function(t,e,r,n){var i=this.codeMirror,o=i.getCursor(),s="RTCMADAPTER"==n&&!i.somethingSelected()&&t==i.indexFromPos(o);this.replaceText(t,null,e,r,n),s&&i.setCursor(o)},t.prototype.removeText=function(t,e,r){var n=this.codeMirror;n.replaceRange("",n.posFromIndex(t),n.posFromIndex(e),r)},t.prototype.insertEntityAtCursor=function(t,e,r){var n=this.codeMirror,i=n.indexFromPos(n.getCursor("head"));this.insertEntityAt(i,t,e,r)},t.prototype.insertEntityAt=function(t,e,r,n){this.codeMirror;this.insertEntity_(t,new O.Entity(e,r),n)},t.prototype.insertEntity_=function(t,e,r){this.replaceText(t,null,s,e.toAttributes(),r)},t.prototype.getAttributeSpans=function(t,e){for(var r=[],n=this.annotationList_.getAnnotatedSpansForSpan(new m(t,e-t)),i=0;i<n.length;i++)r.push({length:n[i].length,attributes:n[i].annotation.attributes});return r},t.prototype.end=function(){var t=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:t,ch:this.codeMirror.getLine(t).length})},t.prototype.getRange=function(t,e){var r=this.codeMirror.posFromIndex(t),n=this.codeMirror.posFromIndex(e);return this.codeMirror.getRange(r,n)},t.prototype.initAnnotationList_=function(){var t=this.end();0!==t&&this.annotationList_.insertAnnotatedSpan(new m(0,t),new y)},t.prototype.onAnnotationsChanged_=function(t,e){var r,n={};this.tryToUpdateEntitiesInPlace(t,e);for(var i=0;i<t.length;i++){var o=t[i].annotation.attributes;d.LINE_SENTINEL in o&&(n[this.codeMirror.posFromIndex(t[i].pos).line]=!0),(r=t[i].getAttachedObject())&&r.clear()}for(i=0;i<e.length;i++){var s=e[i].annotation,a=d.LINE_SENTINEL in s.attributes,h=d.ENTITY_SENTINEL in s.attributes,c=this.codeMirror.posFromIndex(e[i].pos);if(a)n[c.line]=!0;else if(h)this.markEntity_(e[i]);else{var u=this.getClassNameForAttributes_(s.attributes);if(""!==u){var l=this.codeMirror.posFromIndex(e[i].pos+e[i].length);r=this.codeMirror.markText(c,l,{className:u}),e[i].attachObject(r)}}}for(var p in n)this.dirtyLines_.push(this.codeMirror.getLineHandle(Number(p))),this.queueLineMarking_()},t.prototype.tryToUpdateEntitiesInPlace=function(t,e){for(var r=t.length;r--;)for(var n=t[r],i=e.length;i--;){var o=e[i];if(n.pos==o.pos&&n.length==o.length&&n.annotation.attributes.ent&&n.annotation.attributes.ent==o.annotation.attributes.ent){var s=o.annotation.attributes.ent;if(this.entityManager_.entitySupportsUpdate(s)){t.splice(r,1),e.splice(i,1);var a=n.getAttachedObject();a.update(o.annotation.attributes),o.attachObject(a)}}}},t.prototype.queueLineMarking_=function(){if(null==this.lineMarkTimeout_){var o=this;this.lineMarkTimeout_=setTimeout(function(){o.lineMarkTimeout_=null;for(var t=[],e=0;e<o.dirtyLines_.length;e++){var r=o.codeMirror.getLineNumber(o.dirtyLines_[e]);t.push(Number(r))}o.dirtyLines_=[],t.sort(function(t,e){return t-e});var n=-1;for(e=0;e<t.length;e++){var i=t[e];n<i&&(n=o.markLineSentinelCharactersForChangedLines_(i,i))}},0)}},t.prototype.addStyleWithCSS_=function(t){var e=document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css",r.styleSheet?r.styleSheet.cssText=t:r.appendChild(document.createTextNode(t)),e.appendChild(r)},t.prototype.getClassNameForAttributes_=function(t){var e="";for(var r in t){var n=t[r];if(r===d.LINE_SENTINEL)O.utils.assert(!0===n,"LINE_SENTINEL attribute should be true if it exists.");else{var i=(this.options_.cssPrefix||"cmrt-")+r;if(!0!==n){r===d.FONT_SIZE&&"string"!=typeof n&&(n+="px");var o=n.toString().toLowerCase().replace(/[^a-z0-9-_]/g,"-");if(i+="-"+o,c[r]&&(u[r]||(u[r]={}),!u[r][o])){u[r][o]=!0;var s=c[r],a="function"==typeof s?s(n):s+": "+n,h=r==d.LINE_INDENT?"pre."+i:"."+i;this.addStyleWithCSS_(h+" { "+a+" }")}}e=e+" "+i}}return e},t.prototype.markEntity_=function(t){for(var e=t.annotation.attributes,r=O.Entity.fromAttributes(e),n=this.codeMirror,i=this,o=[],s=0;s<t.length;s++){var a=n.posFromIndex(t.pos+s),h=n.posFromIndex(t.pos+s+1),c={collapsed:!0,atomic:!0,inclusiveLeft:!1,inclusiveRight:!1},u=this.createEntityHandle_(r,t.pos),l=this.entityManager_.renderToElement(r,u);l&&(c.replacedWith=l);var p=n.markText(a,h,c);o.push(p),u.setMarker(p)}t.attachObject({clear:function(){for(var t=0;t<o.length;t++)o[t].clear()},update:function(t){for(var e=O.Entity.fromAttributes(t),r=0;r<o.length;r++)i.entityManager_.updateElement(e,o[r].replacedWith)}}),this.queueRefresh_()},t.prototype.queueRefresh_=function(){var t=this;this.refreshTimer_||(this.refreshTimer_=setTimeout(function(){t.codeMirror.refresh(),t.refreshTimer_=null},0))},t.prototype.createEntityHandle_=function(s,e){var r=null,a=this;function h(){if(r){var t=r.find();return t?a.codeMirror.indexFromPos(t.from):null}return e}return{find:h,remove:function(){var t=h();null!=t&&(a.codeMirror.focus(),a.removeText(t,t+1))},replace:function(n){var i=O.AttributeConstants.ENTITY_SENTINEL,o=i+"_",t=h();a.updateTextAttributes(t,t+1,function(t){for(var e in t)delete t[e];for(var r in t[i]=s.type,n)t[o+r]=n[r]})},setMarker:function(t){r=t}}},t.prototype.lineClassRemover_=function(t){var e=this.codeMirror,r=e.getLineHandle(t);return{clear:function(){e.removeLineClass(r,"text",".*")}}},t.prototype.emptySelection_=function(){var t=this.codeMirror.getCursor("start"),e=this.codeMirror.getCursor("end");return t.line===e.line&&t.ch===e.ch},t.prototype.onCodeMirrorBeforeChange_=function(t,e){if("+input"===e.origin||"paste"===e.origin){for(var r=[],n=0;n<e.text.length;n++){var i=e.text[n];i=i.replace(new RegExp("["+p+s+"]","g"),""),r.push(i)}e.update(e.from,e.to,r)}},t.prototype.onCodeMirrorChange_=function(t,e){if("object"==typeof e.from){for(var r=[];e;)r.push(e),e=e.next;e=r}for(var n=this.convertCoordinateSystemForChanges_(e),i=[],o=0;o<n.length;o++){var s,a=n[o],h=a.start,c=(a.end,a.text),u=a.removed,l=a.origin;if(0<u.length){for(var p=this.annotationList_.getAnnotatedSpansForSpan(new m(h,u.length)),d=0,f=0;f<p.length;f++){var g=p[f];i.push({start:h,end:h+g.length,removedAttributes:g.annotation.attributes,removed:u.substr(d,g.length),attributes:{},text:"",origin:a.origin}),d+=g.length}this.annotationList_.removeSpan(new m(h,u.length))}if(0<c.length)"+input"===a.origin||"paste"===a.origin?s=this.currentAttributes_||{}:l in this.outstandingChanges_?(s=this.outstandingChanges_[l].attributes,l=this.outstandingChanges_[l].origOrigin,delete this.outstandingChanges_[l]):s={},this.annotationList_.insertAnnotatedSpan(new m(h,c.length),new y(s)),i.push({start:h,end:h,removedAttributes:{},removed:"",text:c,attributes:s,origin:l})}this.markLineSentinelCharactersForChanges_(e),0<i.length&&this.trigger("change",this,i)},t.prototype.convertCoordinateSystemForChanges_=function(t){var e=this,r=function(t){return e.codeMirror.indexFromPos(t)};function n(r,n){return function(t){return l(t,n.from)?r(t):l(n.to,t)?r({line:t.line+n.text.length-1-(n.to.line-n.from.line),ch:n.to.line<t.line?t.ch:n.text.length<=1?t.ch-(n.to.ch-n.from.ch)+f(n.text):t.ch-n.to.ch+(e=n.text,e[e.length-1]).length})+f(n.removed)-f(n.text):n.from.line===t.line?r(n.from)+t.ch-n.from.ch:r(n.from)+f(n.removed.slice(0,t.line-n.from.line))+1+t.ch;var e}}for(var i=[],o=t.length-1;0<=o;o--){var s=t[o],a=(r=n(r,s))(s.from),h=s.removed.join("\n"),c=s.text.join("\n");i.unshift({start:a,end:a+h.length,removed:h,text:c,origin:s.origin})}return i},t.prototype.markLineSentinelCharactersForChanges_=function(t){for(var e=Number.MAX_VALUE,r=-1,n=0;n<t.length;n++){var i=t[n],o=i.from.line;i.from.ch;(1<i.removed.length||0<=i.removed[0].indexOf(p))&&(e=Math.min(e,o),r=Math.max(r,o)),1<i.text.length?(e=Math.min(e,o),r=Math.max(r,o+i.text.length-1)):0<=i.text[0].indexOf(p)&&(e=Math.min(e,o),r=Math.max(r,o))}r=Math.min(r,this.codeMirror.lineCount()-1),this.markLineSentinelCharactersForChangedLines_(e,r)},t.prototype.markLineSentinelCharactersForChangedLines_=function(t,e){if(t<Number.MAX_VALUE)for(;0<t&&this.lineIsListItemOrIndented_(t-1);)t--;if(-1<e)for(var r=this.codeMirror.lineCount();e+1<r&&this.lineIsListItemOrIndented_(e+1);)e++;for(var n=[],i=this.codeMirror,o=t;o<=e;o++){var s=i.getLine(o),a=i.getLineHandle(o);if(i.removeLineClass(a,"text",".*"),0<s.length)for(var h=s.indexOf(p);0<=h;){for(var c=h;h<s.length&&s[h]===p;){for(var u=i.findMarksAt({line:o,ch:h}),l=0;l<u.length;l++)u[l].isForLineSentinel&&u[l].clear();h++}this.markLineSentinelCharacters_(o,c,h,n),h=s.indexOf(p,h)}else n=[]}return e},t.prototype.markLineSentinelCharacters_=function(t,e,r,n){var i=this.codeMirror,o=null,s=null,a=function(){var t=s.find();return t?t.from.line:null};if(0===e){var h=this.getLineAttributes_(t),c=h[d.LIST_TYPE],u=h[d.LINE_INDENT]||0;for(c&&0===u&&(u=1);u>=n.length;)n.push(1);"o"===c?(o=this.makeOrderedListElement_(n[u]),n[u]++):"u"===c?(o=this.makeUnorderedListElement_(),n[u]=1):"t"===c?(o=this.makeTodoListElement_(!1,a),n[u]=1):"tc"===c&&(o=this.makeTodoListElement_(!0,a),n[u]=1);var l=this.getClassNameForAttributes_(h);""!==l&&this.codeMirror.addLineClass(t,"text",l),n=n.slice(0,u+1)}var p={inclusiveLeft:!0,collapsed:!0};o&&(p.replacedWith=o),(s=i.markText({line:t,ch:e},{line:t,ch:r},p)).isForLineSentinel=!0},t.prototype.makeOrderedListElement_=function(t){return o.elt("div",t+".",{class:"firepad-list-left"})},t.prototype.makeUnorderedListElement_=function(){return o.elt("div","•",{class:"firepad-list-left"})},t.prototype.toggleTodo=function(t){var e,r=d.LIST_TYPE,n=this.getCurrentLineAttributes_();r in n&&("t"===n[r]||"tc"===n[r])?"t"===n[r]?e="tc":"tc"===n[r]&&(e=!!t&&"t"):e="t",this.setLineAttribute(r,e)},t.prototype.makeTodoListElement_=function(t,e){var r={type:"checkbox",class:"firepad-todo-left"};t&&(r.checked=!0);var n=o.elt("input",!1,r),i=this;return o.on(n,"click",o.stopEventAnd(function(t){i.codeMirror.setCursor({line:e(),ch:1}),i.toggleTodo(!0)})),n},t.prototype.lineIsListItemOrIndented_=function(t){var e=this.getLineAttributes_(t);return!1!==(e[d.LIST_TYPE]||!1)||0!==(e[d.LINE_INDENT]||0)},t.prototype.onCursorActivity_=function(){var t=this;setTimeout(function(){t.updateCurrentAttributes_()},1)},t.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},t.prototype.updateCurrentAttributes_=function(){var t=this.codeMirror,e=t.indexFromPos(t.getCursor("anchor")),r=t.indexFromPos(t.getCursor("head")),n=r;if(r<e){for(;n<this.end();){var i=this.getRange(n,n+1);if("\n"!==i&&i!==p)break;n++}n<this.end()&&n++}else for(;0<n&&("\n"===(i=this.getRange(n-1,n))||i===p);)n--;var o=this.annotationList_.getAnnotatedSpansForPos(n);this.currentAttributes_={};var s={};for(var a in 0<o.length&&!(d.LINE_SENTINEL in o[0].annotation.attributes)?s=o[0].annotation.attributes:1<o.length&&(O.utils.assert(!(d.LINE_SENTINEL in o[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),s=o[1].annotation.attributes),s)"l"!==a&&"lt"!==a&&"li"!==a&&0!==a.indexOf(d.ENTITY_SENTINEL)&&(this.currentAttributes_[a]=s[a])},t.prototype.getCurrentLineAttributes_=function(){var t=this.codeMirror,e=t.getCursor("anchor"),r=t.getCursor("head"),n=r.line;return 0===r.ch&&e.line<r.line&&n--,this.getLineAttributes_(n)},t.prototype.getLineAttributes_=function(t){var e={},r=this.codeMirror.getLine(t);if(0<r.length&&r[0]===p){var n=this.codeMirror.indexFromPos({line:t,ch:0}),i=this.annotationList_.getAnnotatedSpansForSpan(new m(n,1));for(var o in O.utils.assert(1===i.length),i[0].annotation.attributes)e[o]=i[0].annotation.attributes[o]}return e},t.prototype.clearAnnotations_=function(){this.annotationList_.updateSpan(new m(0,this.end()),function(t,e){return new y({})})},t.prototype.newline=function(){var t=this.codeMirror,r=this;if(this.emptySelection_()){var n=t.getCursor("head").line,i=this.getLineAttributes_(n),o=i[d.LIST_TYPE];o&&1===t.getLine(n).length?this.updateLineAttributes(n,n,function(t){delete t[d.LIST_TYPE],delete t[d.LINE_INDENT]}):(t.replaceSelection("\n","end","+input"),this.updateLineAttributes(n+1,n+1,function(t){for(var e in i)t[e]=i[e];"tc"===o&&(t[d.LIST_TYPE]="t"),r.trigger("newLine",{line:n+1,attr:t})}))}else t.replaceSelection("\n","end","+input")},t.prototype.deleteLeft=function(){var t=this.codeMirror,e=t.getCursor("head"),r=this.getLineAttributes_(e.line),n=r[d.LIST_TYPE],i=r[d.LINE_INDENT],o=this.emptySelection_()&&1===e.ch;o&&n?this.updateLineAttributes(e.line,e.line,function(t){delete t[d.LIST_TYPE],delete t[d.LINE_INDENT]}):o&&i&&0<i?this.unindent():t.deleteH(-1,"char")},t.prototype.deleteRight=function(){var t=this.codeMirror,e=t.getCursor("head"),r=t.getLine(e.line),n=this.areLineSentinelCharacters_(r),i=e.line+1<t.lineCount()?t.getLine(e.line+1):"";this.emptySelection_()&&n&&i[0]===p?(t.replaceRange("",{line:e.line,ch:0},{line:e.line+1,ch:0},"+input"),t.setCursor({line:e.line,ch:0})):t.deleteH(1,"char")},t.prototype.indent=function(){this.updateLineAttributesForSelection(function(t){var e=t[d.LINE_INDENT],r=t[d.LIST_TYPE];e?t[d.LINE_INDENT]++:t[d.LINE_INDENT]=r?2:1})},t.prototype.unindent=function(){this.updateLineAttributesForSelection(function(t){var e=t[d.LINE_INDENT];e&&1<e?t[d.LINE_INDENT]=e-1:(delete t[d.LIST_TYPE],delete t[d.LINE_INDENT])})},t.prototype.getText=function(){return this.codeMirror.getValue().replace(new RegExp(p,"g"),"")},t.prototype.areLineSentinelCharacters_=function(t){for(var e=0;e<t.length;e++)if(t[e]!==p)return!1;return!0},y.prototype.equals=function(t){if(!(t instanceof y))return!1;var e;for(e in this.attributes)if(t.attributes[e]!==this.attributes[e])return!1;for(e in t.attributes)if(t.attributes[e]!==this.attributes[e])return!1;return!0},t}(),(O=O||{}).RichTextCodeMirrorAdapter=function(){"use strict";var f=O.TextOperation,g=O.WrappedOperation,s=O.Cursor;function n(t){this.rtcm=t,this.cm=t.codeMirror,e(this,"onChange"),e(this,"onAttributesChange"),e(this,"onCursorActivity"),e(this,"onFocus"),e(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function a(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function u(t){var e=t.lineCount()-1;return t.indexFromPos({line:e,ch:t.getLine(e).length})}function l(t,e){if(!t)throw new Error(e||"assertion error")}function e(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}function m(t){for(var e in t)return!1;return!0}function p(t,e){if("string"!=typeof t)throw new TypeError("Expected a string");3===(t=t.replace(/^#/,"")).length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);var r=parseInt(t,16),n=[r>>16,r>>8&255,255&r],i="rgb";return null!=e&&(i="rgba",n.push(e)),i+"("+n.join(",")+")"}return n.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},n.operationFromCodeMirrorChanges=function(t,e){for(var r=u(e),n=(new f).retain(r),i=(new f).retain(r),o=t.length-1;0<=o;o--){var s=t[o],a=s.start,h=r-a-s.text.length;n=(new f).retain(a).delete(s.removed.length).insert(s.text,s.attributes).retain(h).compose(n),i=i.compose((new f).retain(a).delete(s.text.length).insert(s.removed,s.removedAttributes).retain(h)),r+=s.removed.length-s.text.length}return[n,i]},n.operationFromAttributesChanges=function(t,e){for(var r=u(e),n=new f,i=new f,o=0,s=0;s<t.length;s++){var a=t[s],h=a.start-o;l(0<=h),n.retain(h),i.retain(h);var c=a.end-a.start;n.retain(c,a.attributes),i.retain(c,a.attributesInverse),o=a.start+c}return n.retain(r-o),i.retain(r-o),[n,i]},n.prototype.registerCallbacks=function(t){this.callbacks=t},n.prototype.onChange=function(t,e){if("RTCMADAPTER"!==e[0].origin){var r=n.operationFromCodeMirrorChanges(e,this.cm);this.trigger("change",r[0],r[1])}},n.prototype.onAttributesChange=function(t,e){if("RTCMADAPTER"!==e[0].origin){var r=n.operationFromAttributesChanges(e,this.cm);this.trigger("change",r[0],r[1])}},n.prototype.onCursorActivity=function(){var t=this;setTimeout(function(){t.trigger("cursorActivity")},1)},n.prototype.onFocus=function(){this.trigger("focus")},n.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},n.prototype.getValue=function(){return this.cm.getValue()},n.prototype.getCursor=function(){var t,e=this.cm,r=e.getCursor(),n=e.indexFromPos(r);if(e.somethingSelected()){var i=e.getCursor(!0),o=0===a(r,i)?e.getCursor(!1):i;t=e.indexFromPos(o)}else t=n;return new s(n,t)},n.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))},n.prototype.addStyleRule=function(t){if("undefined"!=typeof document&&null!==document){if(!this.addedStyleRules){this.addedStyleRules={};var e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e),this.addedStyleSheet=e.sheet}if(!this.addedStyleRules[t])return this.addedStyleRules[t]=!0,this.addedStyleSheet.insertRule(t,0)}},n.prototype.setOtherCursor=function(t,e,r){var n=this.cm.posFromIndex(t.position);if("string"==typeof e&&e.match(/^#[a-fA-F0-9]{3,6}$/)){var i=this.rtcm.end();if("object"==typeof t&&"number"==typeof t.position&&"number"==typeof t.selectionEnd&&!(t.position<0||t.position>i||t.selectionEnd<0||t.selectionEnd>i)){if(t.position===t.selectionEnd){var o=this.cm.cursorCoords(n),s=document.createElement("span");return s.className="other-client",s.style.borderLeftWidth="2px",s.style.borderLeftStyle="solid",s.style.borderLeftColor=e,s.style.marginLeft=s.style.marginRight="-1px",s.style.height=.9*(o.bottom-o.top)+"px",s.setAttribute("data-clientid",r),s.style.zIndex=0,this.cm.setBookmark(n,{widget:s,insertLeft:!0})}var a,h,c="selection-"+e.replace("#",""),u="."+c+" { background: "+p(e)+";\n background: "+p(e,.4)+";}";return this.addStyleRule(u),h=t.selectionEnd>t.position?(a=n,this.cm.posFromIndex(t.selectionEnd)):(a=this.cm.posFromIndex(t.selectionEnd),n),this.cm.markText(a,h,{className:c})}}},n.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},n.prototype.applyOperation=function(t){10<t.ops.length&&this.rtcm.codeMirror.getWrapperElement().setAttribute("style","display: none");for(var e=t.ops,r=0,n=0,i=e.length;n<i;n++){var o=e[n];o.isRetain()?(m(o.attributes)||this.rtcm.updateTextAttributes(r,r+o.chars,function(t){for(var e in o.attributes)!1===o.attributes[e]?delete t[e]:t[e]=o.attributes[e]},"RTCMADAPTER",!0),r+=o.chars):o.isInsert()?(this.rtcm.insertText(r,o.text,o.attributes,"RTCMADAPTER"),r+=o.text.length):o.isDelete()&&this.rtcm.removeText(r,r+o.chars,"RTCMADAPTER")}10<t.ops.length&&(this.rtcm.codeMirror.getWrapperElement().setAttribute("style",""),this.rtcm.codeMirror.refresh())},n.prototype.registerUndo=function(t){this.cm.undo=t},n.prototype.registerRedo=function(t){this.cm.redo=t},n.prototype.invertOperation=function(t){for(var e,r,n=0,i=this.rtcm.codeMirror,o=new f,s=0;s<t.wrapped.ops.length;s++){var a=t.wrapped.ops[s];if(a.isRetain())if(m(a.attributes))o.retain(a.chars),n+=a.chars;else for(e=this.rtcm.getAttributeSpans(n,n+a.chars),r=0;r<e.length;r++){var h={};for(var c in a.attributes){var u=a.attributes[c],l=e[r].attributes[c];!1===u?l&&(h[c]=l):u!==l&&(h[c]=l||!1)}o.retain(e[r].length,h),n+=e[r].length}else if(a.isInsert())o.delete(a.text.length);else if(a.isDelete()){var p=i.getRange(i.posFromIndex(n),i.posFromIndex(n+a.chars));e=this.rtcm.getAttributeSpans(n,n+a.chars);var d=0;for(r=0;r<e.length;r++)o.insert(p.substr(d,e[r].length),e[r].attributes),d+=e[r].length;n+=a.chars}}return new g(o,t.meta.invert())},n}(),(O=O||{}).Formatting=function(){var e=O.AttributeConstants;function i(t){if(!(this instanceof i))return new i(t);this.attributes=t||{}}return i.prototype.cloneWithNewAttribute_=function(t,e){var r={};for(var n in this.attributes)r[n]=this.attributes[n];return!1===e?delete r[t]:r[t]=e,new i(r)},i.prototype.bold=function(t){return this.cloneWithNewAttribute_(e.BOLD,t)},i.prototype.italic=function(t){return this.cloneWithNewAttribute_(e.ITALIC,t)},i.prototype.underline=function(t){return this.cloneWithNewAttribute_(e.UNDERLINE,t)},i.prototype.strike=function(t){return this.cloneWithNewAttribute_(e.STRIKE,t)},i.prototype.font=function(t){return this.cloneWithNewAttribute_(e.FONT,t)},i.prototype.fontSize=function(t){return this.cloneWithNewAttribute_(e.FONT_SIZE,t)},i.prototype.color=function(t){return this.cloneWithNewAttribute_(e.COLOR,t)},i.prototype.backgroundColor=function(t){return this.cloneWithNewAttribute_(e.BACKGROUND_COLOR,t)},i}(),(O=O||{}).Text=function t(e,r){if(!(this instanceof t))return new t(e,r);this.text=e,this.formatting=r||O.Formatting()},(O=O||{}).LineFormatting=function(){var e=O.AttributeConstants;function i(t){if(!(this instanceof i))return new i(t);this.attributes=t||{},this.attributes[e.LINE_SENTINEL]=!0}return i.LIST_TYPE={NONE:!1,ORDERED:"o",UNORDERED:"u",TODO:"t",TODOCHECKED:"tc"},i.prototype.cloneWithNewAttribute_=function(t,e){var r={};for(var n in this.attributes)r[n]=this.attributes[n];return!1===e?delete r[t]:r[t]=e,new i(r)},i.prototype.indent=function(t){return this.cloneWithNewAttribute_(e.LINE_INDENT,t)},i.prototype.align=function(t){return this.cloneWithNewAttribute_(e.LINE_ALIGN,t)},i.prototype.listItem=function(t){return O.utils.assert(!1===t||"u"===t||"o"===t||"t"===t||"tc"===t),this.cloneWithNewAttribute_(e.LIST_TYPE,t)},i.prototype.getIndent=function(){return this.attributes[e.LINE_INDENT]||0},i.prototype.getAlign=function(){return this.attributes[e.LINE_ALIGN]||0},i.prototype.getListItem=function(){return this.attributes[e.LIST_TYPE]||!1},i}(),(O=O||{}).Line=function t(e,r){if(!(this instanceof t))return new t(e,r);"[object Array]"!==Object.prototype.toString.call(e)&&(e=void 0===e?[]:[e]),this.textPieces=e,this.formatting=r||O.LineFormatting()},(O=O||{}).ParseHtml=function(){var c,u=O.LineFormatting.LIST_TYPE;function i(t,e,r){this.listType=t||u.UNORDERED,this.lineFormatting=e||O.LineFormatting(),this.textFormatting=r||O.Formatting()}function o(){this.lines=[],this.currentLine=[],this.currentLineListItemType=null}i.prototype.withTextFormatting=function(t){return new i(this.listType,this.lineFormatting,t)},i.prototype.withLineFormatting=function(t){return new i(this.listType,t,this.textFormatting)},i.prototype.withListType=function(t){return new i(t,this.lineFormatting,this.textFormatting)},i.prototype.withIncreasedIndent=function(){var t=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new i(this.listType,t,this.textFormatting)},i.prototype.withAlign=function(t){var e=this.lineFormatting.align(t);return new i(this.listType,e,this.textFormatting)},o.prototype.newlineIfNonEmpty=function(t){this.cleanLine_(),0<this.currentLine.length&&this.newline(t)},o.prototype.newlineIfNonEmptyOrListItem=function(t){this.cleanLine_(),(0<this.currentLine.length||null!==this.currentLineListItemType)&&this.newline(t)},o.prototype.newline=function(t){this.cleanLine_();var e=t.lineFormatting;null!==this.currentLineListItemType&&(e=e.listItem(this.currentLineListItemType),this.currentLineListItemType=null),this.lines.push(O.Line(this.currentLine,e)),this.currentLine=[]},o.prototype.makeListItem=function(t){this.currentLineListItemType=t},o.prototype.cleanLine_=function(){if(0<this.currentLine.length){var t=this.currentLine.length-1;this.currentLine[0].text=this.currentLine[0].text.replace(/^ +/,""),this.currentLine[t].text=this.currentLine[t].text.replace(/ +$/g,"");for(var e=0;e<this.currentLine.length;e++)this.currentLine[e].text=this.currentLine[e].text.replace(/\u00a0/g," ")}1===this.currentLine.length&&""===this.currentLine[0].text&&(this.currentLine=[])};var l=l||{ELEMENT_NODE:1,TEXT_NODE:3};function s(t,e,r){if(t.nodeType===l.ELEMENT_NODE){var n=c.fromElement(t);if(n)return void r.currentLine.push(new O.Text(O.sentinelConstants.ENTITY_SENTINEL_CHARACTER,new O.Formatting(n.toAttributes())))}switch(t.nodeType){case l.TEXT_NODE:var i=t.nodeValue.replace(/[ \n\t]+/g," ");r.currentLine.push(O.Text(i,e.textFormatting));break;case l.ELEMENT_NODE:switch(e=function(t,e){for(var r=t.textFormatting,n=t.lineFormatting,i=e.split(";"),o=0;o<i.length;o++){var s=i[o].split(":");if(2===s.length){var a=O.utils.trim(s[0]).toLowerCase(),h=O.utils.trim(s[1]).toLowerCase();switch(a){case"text-decoration":var c=0<=h.indexOf("underline"),u=0<=h.indexOf("line-through");r=r.underline(c).strike(u);break;case"font-weight":var l="bold"===h||600<=parseInt(h);r=r.bold(l);break;case"font-style":var p="italic"===h||"oblique"===h;r=r.italic(p);break;case"color":r=r.color(h);break;case"background-color":r=r.backgroundColor(h);break;case"text-align":n=n.align(h);break;case"font-size":var d=null;O.utils.stringEndsWith(h,["px","pt","%","em","xx-small","x-small","small","medium","large","x-large","xx-large","smaller","larger"])?d=h:parseInt(h)&&(d=parseInt(h)+"px"),d&&(r=r.fontSize(d));break;case"font-family":var f=O.utils.trim(h.split(",")[0]);f=(f=f.replace(/['"]/g,"")).replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()}),r=r.font(f)}}}return t.withLineFormatting(n).withTextFormatting(r)}(e,t.getAttribute("style")||""),t.nodeName.toLowerCase()){case"div":case"h1":case"h2":case"h3":case"p":r.newlineIfNonEmpty(e),p(t,e,r),r.newlineIfNonEmpty(e);break;case"center":e=e.withAlign("center"),r.newlineIfNonEmpty(e),p(t,e.withAlign("center"),r),r.newlineIfNonEmpty(e);break;case"b":case"strong":p(t,e.withTextFormatting(e.textFormatting.bold(!0)),r);break;case"u":p(t,e.withTextFormatting(e.textFormatting.underline(!0)),r);break;case"i":case"em":p(t,e.withTextFormatting(e.textFormatting.italic(!0)),r);break;case"s":p(t,e.withTextFormatting(e.textFormatting.strike(!0)),r);break;case"font":var o=t.getAttribute("face"),s=t.getAttribute("color"),a=parseInt(t.getAttribute("size"));o&&(e=e.withTextFormatting(e.textFormatting.font(o))),s&&(e=e.withTextFormatting(e.textFormatting.color(s))),a&&(e=e.withTextFormatting(e.textFormatting.fontSize(a))),p(t,e,r);break;case"br":r.newline(e);break;case"ul":r.newlineIfNonEmptyOrListItem(e);var h="firepad-todo"===t.getAttribute("class")?u.TODO:u.UNORDERED;p(t,e.withListType(h).withIncreasedIndent(),r),r.newlineIfNonEmpty(e);break;case"ol":r.newlineIfNonEmptyOrListItem(e),p(t,e.withListType(u.ORDERED).withIncreasedIndent(),r),r.newlineIfNonEmpty(e);break;case"li":!function(t,e,r){r.newlineIfNonEmptyOrListItem(e);var n="firepad-checked"===t.getAttribute("class")?u.TODOCHECKED:e.listType;r.makeListItem(n);var i=r.currentLine;p(t,e,r),(i===r.currentLine||0<r.currentLine.length)&&r.newline(e)}(t,e,r);break;case"style":break;default:p(t,e,r)}}}function p(t,e,r){if(t.hasChildNodes())for(var n=0;n<t.childNodes.length;n++)s(t.childNodes[n],e,r)}return function(t,e){var r=(O.document||document).createElement("div");r.innerHTML=t,c=e;var n=new o;return s(r,new i,n),n.lines}}(),(O=O||{}).SerializeHtml=function(){var N=O.utils,k=O.AttributeConstants,R=O.LineFormatting.LIST_TYPE;function F(t){return t===R.ORDERED?"</ol>":"</ul>"}return function(t,e){for(var r,n,i,o="",s=!0,a=[],h=!1,c=!0,u=!0,l=0,p=t.ops[l],d=!1;p;){N.assert(p.isInsert());var f=p.attributes;if(s){s=!1;var g=0,m=null,y="left";k.LINE_SENTINEL in f&&(g=f[k.LINE_INDENT]||0,m=f[k.LIST_TYPE]||null,y=f[k.LINE_ALIGN]||"left"),m&&(g=g||1),h?(o+="</li>",h=!1):c||(u&&(o+="<br/>"),o+="</div>"),c=!1,N.assert(0<=g,"Indent must not be negative.");for(;a.length>g||g===a.length&&null!==m&&(n=m,i=a[a.length-1],!(n===i||n===R.TODO&&i===R.TODOCHECKED||n===R.TODOCHECKED&&i===R.TODO));)o+=F(a.pop());for(;a.length<g;){var v=m||R.UNORDERED;d=m==R.TODO||m==R.TODOCHECKED||d,o+=(r=v)===R.ORDERED?"<ol>":r===R.UNORDERED?"<ul>":'<ul class="firepad-todo">',a.push(v)}var _="left"!==y?' style="text-align:'+y+'"':"";if(m){var b="";switch(m){case R.TODOCHECKED:b=' class="firepad-checked"';break;case R.TODO:b=' class="firepad-unchecked"'}o+="<li"+b+_+">",h=!0}else o+="<div"+_+">";u=!0}if(k.LINE_SENTINEL in f)p=t.ops[++l];else if(k.ENTITY_SENTINEL in f){for(var C=0;C<p.text.length;C++){var E=O.Entity.fromAttributes(f);o+=e.exportToElement(E).outerHTML}p=t.ops[++l]}else{var x="",w="";for(var L in f){var T,A,I=f[L];L===k.BOLD||L===k.ITALIC||L===k.UNDERLINE||L===k.STRIKE?(N.assert(!0===I),T=A=L):L===k.FONT_SIZE?(T='span style="font-size: '+I,T+="string"!=typeof I||-1===I.indexOf("px",I.length-2)?'px"':'"',A="span"):L===k.FONT?(T='span style="font-family: '+I+'"',A="span"):L===k.COLOR?(T='span style="color: '+I+'"',A="span"):L===k.BACKGROUND_COLOR?(T='span style="background-color: '+I+'"',A="span"):N.log(!1,"Encountered unknown attribute while rendering html: "+L),T&&(x+="<"+T+">"),A&&(w="</"+A+">"+w)}var S=p.text,M=S.indexOf("\n");0<=M?(s=!0,p=M<S.length-1?new O.TextOp("insert",S.substr(M+1),f):t.ops[++l],S=S.substr(0,M)):p=t.ops[++l],0<(S=S.replace(/  +/g,function(t){return new Array(t.length+1).join(" ")}).replace(/^ /," ").replace(/ $/," ")).length&&(u=!1),o+=x+S.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00a0/g,"&nbsp;")+w}}for(h?o+="</li>":c||(u&&(o+="&nbsp;"),o+="</div>");0<a.length;)o+=F(a.pop());return d&&(o='<style>ul.firepad-todo { list-style: none; margin-left: 0; padding-left: 0; } ul.firepad-todo > li { padding-left: 1em; text-indent: -1em; } ul.firepad-todo > li:before { content: "\\2610"; padding-right: 5px; } ul.firepad-todo > li.firepad-checked:before { content: "\\2611"; padding-right: 5px; }</style>\n'+o),o}}(),(O=O||{}).textPiecesToInserts=function(n,t){var r=[];function i(t,e){t instanceof O.Text&&(e=t.formatting.attributes,t=t.text),r.push({string:t,attributes:e}),n="\n"===t[t.length-1]}function e(t,e){n&&i(O.sentinelConstants.LINE_SENTINEL_CHARACTER,t.formatting.attributes);for(var r=0;r<t.textPieces.length;r++)i(t.textPieces[r]);e&&i("\n")}for(var o=0;o<t.length;o++)t[o]instanceof O.Line?e(t[o],o<t.length-1):i(t[o]);return r},(O=O||{}).Headless=function(){var a=O.TextOperation,n=O.FirebaseAdapter,i=O.EntityManager,h=O.ParseHtml;function o(t){if(!(this instanceof o))return new o(t);var e,r;r="string"==typeof t?(e=void 0===window.firebase&&"object"!=typeof e?(console.log("REQUIRING"),require("firebase")):window.firebase).database().refFromURL(t):t,this.entityManager_=new i,this.firebaseAdapter_=new n(r),this.ready_=!1,this.zombie_=!1}return o.prototype.getDocument=function(t){var e=this;if(e.ready_)return t(e.firebaseAdapter_.getDocument());e.firebaseAdapter_.on("ready",function(){e.ready_=!0,t(e.firebaseAdapter_.getDocument())})},o.prototype.getText=function(r){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");this.getDocument(function(t){var e=t.apply("");for(key in O.sentinelConstants)e=e.replace(new RegExp(O.sentinelConstants[key],"g"),"");r(e)})},o.prototype.setText=function(t,e){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");var r=a().insert(t);this.sendOperationWithRetry(r,e)},o.prototype.initializeFakeDom=function(r){"object"==typeof document||"object"==typeof O.document?r():require("jsdom").env("<head></head><body></body>",function(t,e){if(O.document)return e.close(),r();O.document=e.document,r()})},o.prototype.getHtml=function(e){var r=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");r.initializeFakeDom(function(){r.getDocument(function(t){e(O.SerializeHtml(t,r.entityManager_))})})},o.prototype.setHtml=function(i,o){var s=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");s.initializeFakeDom(function(){for(var t=h(i,s.entityManager_),e=O.textPiecesToInserts(!0,t),r=new a,n=0;n<e.length;n++)r.insert(e[n].string,e[n].attributes);s.sendOperationWithRetry(r,o)})},o.prototype.sendOperationWithRetry=function(r,n){var i=this;i.getDocument(function(t){var e=r.clone().delete(t.targetLength);i.firebaseAdapter_.sendOperation(e,function(t,e){e?void 0!==n&&n(null,e):i.sendOperationWithRetry(r,n)})})},o.prototype.dispose=function(){this.zombie_=!0,this.firebaseAdapter_.dispose()},o}(),(O=O||{}).Firepad=function(h){if(!O.RichTextCodeMirrorAdapter)throw new Error("Oops! It looks like you're trying to include lib/firepad.js directly.  This is actually one of many source files that make up firepad.  You want dist/firepad.js instead.");var c=O.RichTextCodeMirrorAdapter,u=O.RichTextCodeMirror,t=O.RichTextToolbar,l=O.ACEAdapter,p=O.MonacoAdapter,d=O.FirebaseAdapter,f=O.EditorClient,g=O.EntityManager,e=O.AttributeConstants,m=O.utils,y=(O.LineFormatting.LIST_TYPE,h.CodeMirror),v=h.ace;h.monaco;function _(t,e,r){if(!(this instanceof _))return new _(t,e,r);if(!y&&!v&&!h.monaco)throw new Error("Couldn't find CodeMirror, ACE or Monaco.  Did you forget to include codemirror.js/ace.js or import monaco?");if(this.zombie_=!1,y&&e instanceof y){this.codeMirror_=this.editor_=e;var n=this.codeMirror_.getValue();if(""!==n)throw new Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else if(v&&e&&e.session instanceof v.EditSession){if(this.ace_=this.editor_=e,""!==(n=this.ace_.getValue()))throw new Error("Can't initialize Firepad with an ACE instance that already contains text.")}else if(h.monaco&&e&&e instanceof h.monaco.constructor){if(h.monaco,this.monaco_=this.editor_=e,""!==(n=this.monaco_.getValue()))throw new Error("Can't initialize Firepad with a Monaco instance that already contains text.")}else this.codeMirror_=this.editor_=new y(e);var i;i=this.codeMirror_?this.codeMirror_.getWrapperElement():this.ace_?this.ace_.container:this.monaco_.getDomNode(),this.firepadWrapper_=m.elt("div",null,{class:"firepad"}),i.parentNode.replaceChild(this.firepadWrapper_,i),this.firepadWrapper_.appendChild(i),m.on(i,"dragstart",m.stopEvent),(this.editor_.firepad=this).options_=r||{},this.getOption("richTextShortcuts",!1)&&(y.keyMap.richtext||this.initializeKeyMap_(),this.codeMirror_.setOption("keyMap","richtext"),this.firepadWrapper_.className+=" firepad-richtext"),this.imageInsertionUI=this.getOption("imageInsertionUI",!0),this.getOption("richTextToolbar",!1)&&(this.addToolbar_(),this.firepadWrapper_.className+=" firepad-richtext firepad-with-toolbar"),this.addPoweredByLogo_(),this.codeMirror_&&this.codeMirror_.refresh();var o=this.getOption("userId",t.push().key),s=this.getOption("userColor",function(t){for(var e=1,r=0;r<t.length;r++)e=17*(e+t.charCodeAt(r))%360;return function(t,e,r){if(0===e)return b(r,r,r);var n=r<.5?r*(1+e):r+e-e*r,i=2*r-n,o=function(t){return t<0&&(t+=1),1<t&&(t-=1),6*t<1?i+6*(n-i)*t:2*t<1?n:3*t<2?i+6*(n-i)*(2/3-t):i};return b(o(t+1/3),o(t),o(t-1/3))}(e/360,1,.75)}(o));this.entityManager_=new g,this.firebaseAdapter_=new d(t,o,s),this.codeMirror_?(this.richTextCodeMirror_=new u(this.codeMirror_,this.entityManager_,{cssPrefix:"firepad-"}),this.editorAdapter_=new c(this.richTextCodeMirror_)):this.ace_?this.editorAdapter_=new l(this.ace_):this.editorAdapter_=new p(this.monaco_),this.client_=new f(this.firebaseAdapter_,this.editorAdapter_);var a=this;this.firebaseAdapter_.on("cursor",function(){a.trigger.apply(a,["cursor"].concat([].slice.call(arguments)))}),this.codeMirror_&&this.richTextCodeMirror_.on("newLine",function(){a.trigger.apply(a,["newLine"].concat([].slice.call(arguments)))}),this.firebaseAdapter_.on("ready",function(){a.ready_=!0,this.ace_&&this.editorAdapter_.grabDocumentState(),this.monaco_&&this.editorAdapter_.grabDocumentState();var t=a.getOption("defaultText",null);t&&a.isHistoryEmpty()&&a.setText(t),a.trigger("ready")}),this.client_.on("synced",function(t){a.trigger("synced",t)}),"Microsoft Internet Explorer"==navigator.appName&&navigator.userAgent.match(/MSIE 8\./)&&(window.onload=function(){var t=document.getElementsByTagName("head")[0],e=document.createElement("style");e.type="text/css",e.styleSheet.cssText=":before,:after{content:none !important;}",t.appendChild(e),setTimeout(function(){t.removeChild(e)},0)})}function b(t,e,r){function n(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+n(t)+n(e)+n(r)}return m.makeEventEmitter(_),(((_.fromCodeMirror=_).fromACE=_).fromMonaco=_).prototype.dispose=function(){this.zombie_=!0,this.codeMirror_?editorWrapper=this.codeMirror_.getWrapperElement():this.ace_?editorWrapper=this.ace_.container:editorWrapper=this.monaco_.getDomNode(),this.firepadWrapper_.removeChild(editorWrapper),this.firepadWrapper_.parentNode.replaceChild(editorWrapper,this.firepadWrapper_),this.editor_.firepad=null,this.codeMirror_&&"richtext"===this.codeMirror_.getOption("keyMap")&&this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.editorAdapter_.detach(),this.richTextCodeMirror_&&this.richTextCodeMirror_.detach()},_.prototype.setUserId=function(t){this.firebaseAdapter_.setUserId(t)},_.prototype.setUserColor=function(t){this.firebaseAdapter_.setColor(t)},_.prototype.getText=function(){return this.assertReady_("getText"),this.codeMirror_?this.richTextCodeMirror_.getText():this.ace_?this.ace_.getSession().getDocument().getValue():this.monaco_.getModel().getValue()},_.prototype.setText=function(t){return this.assertReady_("setText"),this.monaco_?this.monaco_.getModel().setValue(t):this.ace_?this.ace_.getSession().getDocument().setValue(t):(this.codeMirror_.getWrapperElement().setAttribute("style","display: none"),this.codeMirror_.setValue(""),this.insertText(0,t),this.codeMirror_.getWrapperElement().setAttribute("style",""),this.codeMirror_.refresh(),void this.editorAdapter_.setCursor({position:0,selectionEnd:0}))},_.prototype.insertTextAtCursor=function(t){this.insertText(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},_.prototype.insertText=function(o,s){m.assert(!this.ace_,"Not supported for ace yet."),m.assert(!this.monaco_,"Not supported for monaco yet."),this.assertReady_("insertText"),"[object Array]"!==Object.prototype.toString.call(s)&&(s=[s]);var a=this;a.codeMirror_.operation(function(){for(var t=0===o,e=O.textPiecesToInserts(t,s),r=0;r<e.length;r++){var n=e[r].string,i=e[r].attributes;a.richTextCodeMirror_.insertText(o,n,i),o+=n.length}})},_.prototype.getOperationForSpan=function(t,e){for(var r=this.richTextCodeMirror_.getRange(t,e),n=this.richTextCodeMirror_.getAttributeSpans(t,e),i=0,o=new O.TextOperation,s=0;s<n.length;s++)o.insert(r.substr(i,n[s].length),n[s].attributes),i+=n[s].length;return o},_.prototype.getHtml=function(){return this.getHtmlFromRange(null,null)},_.prototype.getHtmlFromSelection=function(){var t=this.codeMirror_.getCursor("start"),e=this.codeMirror_.getCursor("end"),r=this.codeMirror_.indexFromPos(t),n=this.codeMirror_.indexFromPos(e);return this.getHtmlFromRange(r,n)},_.prototype.getHtmlFromRange=function(t,e){this.assertReady_("getHtmlFromRange");var r=null!=t&&null!=e?this.getOperationForSpan(t,e):this.getOperationForSpan(0,this.codeMirror_.getValue().length);return O.SerializeHtml(r,this.entityManager_)},_.prototype.insertHtml=function(t,e){var r=O.ParseHtml(e,this.entityManager_);this.insertText(t,r)},_.prototype.insertHtmlAtCursor=function(t){this.insertHtml(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},_.prototype.setHtml=function(t){var e=O.ParseHtml(t,this.entityManager_);this.setText(e)},_.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},_.prototype.bold=function(){this.richTextCodeMirror_.toggleAttribute(e.BOLD),this.codeMirror_.focus()},_.prototype.italic=function(){this.richTextCodeMirror_.toggleAttribute(e.ITALIC),this.codeMirror_.focus()},_.prototype.underline=function(){this.richTextCodeMirror_.toggleAttribute(e.UNDERLINE),this.codeMirror_.focus()},_.prototype.strike=function(){this.richTextCodeMirror_.toggleAttribute(e.STRIKE),this.codeMirror_.focus()},_.prototype.fontSize=function(t){this.richTextCodeMirror_.setAttribute(e.FONT_SIZE,t),this.codeMirror_.focus()},_.prototype.font=function(t){this.richTextCodeMirror_.setAttribute(e.FONT,t),this.codeMirror_.focus()},_.prototype.color=function(t){this.richTextCodeMirror_.setAttribute(e.COLOR,t),this.codeMirror_.focus()},_.prototype.highlight=function(){this.richTextCodeMirror_.toggleAttribute(e.BACKGROUND_COLOR,"rgba(255,255,0,.65)"),this.codeMirror_.focus()},_.prototype.align=function(t){if("left"!==t&&"center"!==t&&"right"!==t)throw new Error('align() must be passed "left", "center", or "right".');this.richTextCodeMirror_.setLineAttribute(e.LINE_ALIGN,t),this.codeMirror_.focus()},_.prototype.orderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(e.LIST_TYPE,"o"),this.codeMirror_.focus()},_.prototype.unorderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(e.LIST_TYPE,"u"),this.codeMirror_.focus()},_.prototype.todo=function(){this.richTextCodeMirror_.toggleTodo(),this.codeMirror_.focus()},_.prototype.newline=function(){this.richTextCodeMirror_.newline()},_.prototype.deleteLeft=function(){this.richTextCodeMirror_.deleteLeft()},_.prototype.deleteRight=function(){this.richTextCodeMirror_.deleteRight()},_.prototype.indent=function(){this.richTextCodeMirror_.indent(),this.codeMirror_.focus()},_.prototype.unindent=function(){this.richTextCodeMirror_.unindent(),this.codeMirror_.focus()},_.prototype.undo=function(){this.codeMirror_.undo()},_.prototype.redo=function(){this.codeMirror_.redo()},_.prototype.insertEntity=function(t,e,r){this.richTextCodeMirror_.insertEntityAtCursor(t,e,r)},_.prototype.insertEntityAt=function(t,e,r,n){this.richTextCodeMirror_.insertEntityAt(t,e,r,n)},_.prototype.registerEntity=function(t,e){this.entityManager_.register(t,e)},_.prototype.getOption=function(t,e){return t in this.options_?this.options_[t]:e},_.prototype.assertReady_=function(t){if(!this.ready_)throw new Error('You must wait for the "ready" event before calling '+t+".");if(this.zombie_)throw new Error("You can't use a Firepad after calling dispose()!  [called "+t+"]")},_.prototype.makeImageDialog_=function(){this.makeDialog_("img","Insert image url")},_.prototype.makeDialog_=function(r,t){var n=this,e=m.elt("input",null,{class:"firepad-dialog-input",id:r,type:"text",placeholder:t,autofocus:"autofocus"}),i=m.elt("a","Submit",{class:"firepad-btn",id:"submitbtn"});m.on(i,"click",m.stopEventAnd(function(){var t=document.getElementById("overlay");t.style.visibility="hidden";var e=document.getElementById(r).value;null!==e&&n.insertEntity(r,{src:e}),n.firepadWrapper_.removeChild(t)}));var o=m.elt("a","Cancel",{class:"firepad-btn"});m.on(o,"click",m.stopEventAnd(function(){var t=document.getElementById("overlay");t.style.visibility="hidden",n.firepadWrapper_.removeChild(t)}));var s=m.elt("div",[i,o],{class:"firepad-btn-group"}),a=m.elt("div",[e,s],{class:"firepad-dialog-div"}),h=m.elt("div",[a],{class:"firepad-dialog",id:"overlay"});this.firepadWrapper_.appendChild(h)},_.prototype.addToolbar_=function(){this.toolbar=new t(this.imageInsertionUI),this.toolbar.on("undo",this.undo,this),this.toolbar.on("redo",this.redo,this),this.toolbar.on("bold",this.bold,this),this.toolbar.on("italic",this.italic,this),this.toolbar.on("underline",this.underline,this),this.toolbar.on("strike",this.strike,this),this.toolbar.on("font-size",this.fontSize,this),this.toolbar.on("font",this.font,this),this.toolbar.on("color",this.color,this),this.toolbar.on("left",function(){this.align("left")},this),this.toolbar.on("center",function(){this.align("center")},this),this.toolbar.on("right",function(){this.align("right")},this),this.toolbar.on("ordered-list",this.orderedList,this),this.toolbar.on("unordered-list",this.unorderedList,this),this.toolbar.on("todo-list",this.todo,this),this.toolbar.on("indent-increase",this.indent,this),this.toolbar.on("indent-decrease",this.unindent,this),this.toolbar.on("insert-image",this.makeImageDialog_,this),this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild)},_.prototype.addPoweredByLogo_=function(){var t=m.elt("a",null,{class:"powered-by-firepad"});t.setAttribute("href","http://www.firepad.io/"),t.setAttribute("target","_blank"),this.firepadWrapper_.appendChild(t)},_.prototype.initializeKeyMap_=function(){function t(e){return function(t){setTimeout(function(){e.call(t.firepad)},0)}}y.keyMap.richtext={"Ctrl-B":t(this.bold),"Cmd-B":t(this.bold),"Ctrl-I":t(this.italic),"Cmd-I":t(this.italic),"Ctrl-U":t(this.underline),"Cmd-U":t(this.underline),"Ctrl-H":t(this.highlight),"Cmd-H":t(this.highlight),Enter:t(this.newline),Delete:t(this.deleteRight),Backspace:t(this.deleteLeft),Tab:t(this.indent),"Shift-Tab":t(this.unindent),fallthrough:["default"]}},_}(this),O.Firepad.Formatting=O.Formatting,O.Firepad.Text=O.Text,O.Firepad.Entity=O.Entity,O.Firepad.LineFormatting=O.LineFormatting,O.Firepad.Line=O.Line,O.Firepad.TextOperation=O.TextOperation,O.Firepad.Headless=O.Headless,O.Firepad.RichTextCodeMirrorAdapter=O.RichTextCodeMirrorAdapter,O.Firepad.ACEAdapter=O.ACEAdapter,O.Firepad.MonacoAdapter=O.MonacoAdapter,O.Firepad},this);